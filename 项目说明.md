# 微信商户号申诉专业助手 v2.0 — 项目说明

## 一、项目概述

**项目名称**：微信商户号申诉专业助手（Merchant Appeal Assistant）
**当前版本**：v2.0.0
**项目类型**：AI 驱动的 SaaS 工具型 Web 应用
**开源协议**：MIT License
**作者**：aiyang（GitHub: aiyangdie）

### 1.1 项目定位

本项目是一个**可直接商用的智能申诉工具**，面向微信支付商户号被风控处罚（冻结、封禁、限额、拦截）的商户群体。通过 AI 对话引擎自动收集商户信息，结合专业知识库和成功案例，智能生成符合微信官方要求的申诉材料，大幅降低申诉门槛并提升通过率。

### 1.2 解决的核心痛点

| 痛点 | 解决方案 |
|------|----------|
| 商户不知道需要准备哪些材料 | AI 对话自动引导收集所有必要信息 |
| 申诉材料不专业、漏洞百出 | 基于行业知识库 + 成功案例自动生成专业申诉文案 |
| 不了解被处罚原因和应对策略 | 12 种违规类型专业知识 + 风控逆向推演分析 |
| 找专业顾问费用高昂 | Token 计费模式，单次成本低至几毛钱 |
| 模板化申诉千篇一律 | AI 根据每个商户具体情况定制个性化申诉方案 |
| 被驳回后不知如何应对 | 驳回预案 + 二次申诉策略 + 95017 电话话术 |

### 1.3 核心数据

- 覆盖 **30+** 行业知识库
- **12 种**违规类型专业知识（含申诉策略、材料清单、成功率预估）
- **16 个**真实成功案例模板（覆盖拦截/限额/关闭/冻结/封禁）
- **10+** 敏感行业智能检测
- **16 项**基础信息收集 + 行业动态扩展字段
- **8 处** AI 调用点（对话/提取/评估/报告/行业扩展/分析/规则/聚合）

---


## 二、技术架构

### 2.1 整体架构

```
用户浏览器                         服务端                           外部服务
┌──────────────┐              ┌─────────────────┐            ┌──────────────┐
│  React 18    │  SSE Stream  │  Express API    │            │ 多AI模型     │
│  TailwindCSS │◄────────────►│                 │◄──────────►│ DeepSeek     │
│  React Router│              │  ┌───────────┐  │            │ 智谱/通义/   │
└──────────────┘              │  │ 规则引擎   │  │            │ Moonshot等   │
                              │  │ (localAI)  │  │            └──────────────┘
                              │  └───────────┘  │
                              │  ┌───────────┐  │            ┌──────────────┐
                              │  │ 进化引擎V3 │  │◄──────────►│  MySQL 8.0   │
                              │  │ 自动学习   │  │            │  25+表       │
                              │  └───────────┘  │            └──────────────┘
                              │  ┌───────────┐  │
                              │  │ 模型健康   │  │
                              │  │ 自动切换   │  │
                              │  └───────────┘  │
                              └─────────────────┘
```

### 2.2 技术栈详情

| 层级 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **前端框架** | React + React Router | 18 / 6 | SPA 单页应用 + 路由管理 |
| **UI 样式** | TailwindCSS | 3.4 | 原子化 CSS，快速开发 |
| **构建工具** | Vite | 6 | 极速 HMR + 构建优化（含代码分割） |
| **后端框架** | Express | 4 | REST API + SSE 流式响应 |
| **数据库** | MySQL (mysql2) | 8.0 | 数据持久化，25+ 张表自动创建 |
| **AI 引擎** | 多模型抽象层 | — | DeepSeek/智谱/通义/Moonshot 等 15+ 模型 |
| **进化引擎** | 自研 Evolution Engine V3 | — | 对话分析→规则生成→A/B测试→自动升降级 |
| **健康检测** | 自研 Model Health Monitor | — | 30分钟巡检/故障自动切换/免费模型回退 |
| **安全** | helmet + cors + rate-limit + JWT + AES-256 | — | 全方位安全防护 |
| **Token 计算** | js-tiktoken | 1.0 | 精确 Token 计数（cl100k_base 编码） |
| **密码加密** | bcryptjs | 3.0 | 用户密码哈希存储 |
| **进程管理** | PM2（生产环境） | — | 守护进程 + 自动重启 |

### 2.3 前端路由结构

| 路径 | 组件 | 说明 |
|------|------|------|
| / | ChatPage | 主对话页面（含登录/注册/对话/历史/智能快捷回复/导出） |
| /admin | AdminLogin | 管理员登录页 |
| /admin/dashboard | AdminPage | 管理后台仪表盘（含监控/备份/模型管理） |
| /service/:orderNo | ServicePage | 🆕 客服服务页面（专属顾问对话） |

### 2.4 前端组件说明（21个）

#### 核心对话组件

| 组件 | 文件 | 功能 |
|------|------|------|
| ChatMessage | ChatMessage.jsx | 聊天消息气泡（Markdown渲染+延迟/Token用量显示） |
| InfoPanel | InfoPanel.jsx | 信息收集面板（9组分类+动态扩展+手动修改） |
| TypingIndicator | TypingIndicator.jsx | AI 正在输入动画 |
| UserAvatar | UserAvatar.jsx | 🆕 用户头像组件 |

#### 分析与申诉组件

| 组件 | 文件 | 功能 |
|------|------|------|
| AIAnalysisPanel | AIAnalysisPanel.jsx | AI 深度分析面板（风控推演/证据链/行动计划） |
| AnalysisVisualView | AnalysisVisualView.jsx | 分析结果可视化视图 |
| AppealTextPanel | AppealTextPanel.jsx | 申诉文案面板（进度跟踪+反馈闭环） |
| AppealGuidePanel | AppealGuidePanel.jsx | 🆕 申诉指导面板（流程+进度追踪+结果反馈+重申策略） |
| ComplaintDocPanel | ComplaintDocPanel.jsx | 🆕 投诉材料整理面板（投诉回复话术生成） |
| ReportCard | ReportCard.jsx | 申诉报告卡片展示 |

#### 管理与运营组件

| 组件 | 文件 | 功能 |
|------|------|------|
| TokenPanel | TokenPanel.jsx | Token 消耗可视化面板（盈亏/IO比例/按功能分类） |
| QualityDashboard | QualityDashboard.jsx | 质量评分仪表盘 |
| EvolutionPanel | EvolutionPanel.jsx | AI 进化引擎面板（分析/规则/打标/聚合） |
| MallPanel | MallPanel.jsx | 智能商城面板（商品管理+AI推荐） |
| UserCenter | UserCenter.jsx | 用户中心（余额/充值/用量/🆕申诉记录） |
| ContactCardsPanel | ContactCardsPanel.jsx | 🆕 联系人名片面板 |
| AIActivityPanel | AIActivityPanel.jsx | 🆕 AI 活动监控面板 |
| AIModelsPanel | AIModelsPanel.jsx | 🆕 AI 模型管理面板（CRUD/健康检测/切换） |
| MonitorPanel | MonitorPanel.jsx | 🆕 系统监控面板（服务器状态/API统计） |
| BackupPanel | BackupPanel.jsx | 🆕 备份管理面板（数据库备份/恢复） |
| ErrorBoundary | ErrorBoundary.jsx | React 错误边界 |

---


## 三、后端模块详解

### 3.1 服务端文件结构（v2.0 MVC架构）

```
server/
├── index.js               # Express 主入口（100+ API 路由，SSE 流式聊天）
├── app.js                 # 🆕 Express 应用初始化（中间件配置）
├── ai.js                  # 多模型 AI 调用层（System Prompt + 动态策略注入）
├── localAI.js             # 本地规则引擎（对话流程+输入验证+报告生成，零Token消耗）
├── knowledgeBase.js       # 行业知识库（12种违规类型+16个案例+风险评估+材料清单）
├── evolution.js           # AI 自进化引擎 V3（分析/规则生成/打标/聚合/A|B测试）
├── modelHealth.js         # 模型健康检测（30分钟巡检+故障自动切换）
├── mall.js                # 智能商城推荐引擎（商品管理+AI推荐+用户兴趣追踪）
├── db.js                  # MySQL 数据访问层（25+表，自动建表+自动迁移）
├── tokenizer.js           # Token 统计与计费（js-tiktoken，cl100k_base）
├── monitor.js             # 🆕 系统监控服务（服务器状态+API调用统计）
├── payment.js             # 🆕 支付系统（订单管理+支付流程）
├── backup.js              # 🆕 备份管理（数据库备份+恢复）
├── controllers/           # 🆕 MVC 控制器层
│   ├── aiController.js    #   AI 对话控制器（RAG增强）
│   ├── appealController.js#   申诉业务控制器
│   ├── sessionController.js#  会话管理控制器
│   ├── userController.js  #   用户管理控制器
│   └── rechargeController.js# 充值管理控制器
├── models/                # 🆕 数据模型层（10个模型）
│   ├── Appeal.js          #   申诉模型（状态追踪+反馈+重申）
│   ├── Session.js         #   会话模型（collected_data JSON）
│   ├── User.js            #   用户模型（加密手机号+余额+API模式）
│   ├── Message.js         #   消息模型（user/assistant/admin角色）
│   ├── Order.js           #   商城订单模型
│   ├── Product.js         #   商品模型
│   ├── TokenUsage.js      #   Token用量模型
│   ├── RechargeOrder.js   #   充值订单模型
│   ├── KnowledgeBase.js   #   知识库模型
│   └── SystemConfig.js    #   系统配置模型
├── services/              # 🆕 业务服务层
│   ├── appealService.js   #   申诉业务逻辑（进度追踪+重申策略）
│   ├── sessionService.js  #   会话业务逻辑
│   ├── userService.js     #   用户业务逻辑
│   └── messageService.js  #   消息业务逻辑
├── routes/                # 🆕 路由层
│   ├── index.js           #   路由汇总注册
│   ├── aiRoutes.js        #   AI 相关路由
│   ├── appealRoutes.js    #   申诉相关路由
│   ├── sessionRoutes.js   #   会话相关路由
│   ├── userRoutes.js      #   用户相关路由
│   └── paymentRoutes.js   #   支付相关路由
├── middleware/             # 🆕 中间件层
│   ├── auth.js            #   JWT 认证中间件（用户端/管理端分离）
│   └── errorHandler.js    #   全局错误处理中间件
├── config/                # 🆕 配置层
│   ├── database.js        #   数据库连接池配置
│   ├── initDb.js          #   数据库初始化（自动建表+迁移）
│   └── seedData.js        #   种子数据（初始案例+配置）
├── ai/                    # 🆕 AI 子模块
│   ├── core/llm.js        #   LLM 调用核心封装
│   └── rag/ragService.js  #   RAG 检索增强生成服务
└── utils/                 # 🆕 工具库
    ├── crypto.js          #   AES-256-GCM 加解密 + SHA-256 HMAC
    ├── jsonHelper.js      #   JSON 安全解析
    └── logger.js          #   日志工具
```

### 3.2 各模块功能详述

#### 3.2.1 index.js — Express 主入口

- **安全中间件**：helmet（安全头）、CORS、全局速率限制（100次/分钟）、聊天独立限速（20次/分钟）
- **JWT 认证体系**：用户端和管理端分离，24小时过期
- **SSE 流式传输**：AI 对话采用 Server-Sent Events 实时流式输出，首字节延迟 < 1 秒
- **100+ API 路由**：涵盖用户管理、会话管理、AI对话、申诉文案、充值系统、管理后台等全部业务
- **静态文件托管**：生产环境直接托管 dist/ 前端构建产物

#### 3.2.2 i.js — 多模型 AI 调用层

- **多模型抽象层**：统一封装 DeepSeek、智谱、通义千问、Moonshot 等 15+ 模型的 API 调用
- **AI 配置管理**：从数据库 i_models 表读取当前激活模型，支持运行时切换
- **核心 System Prompt**：内置 8 年申诉实战经验的角色设定，包含三层深度推理框架
- **用户水平自适应**：自动识别小白用户（80%）和老手用户（20%），动态调整沟通方式
- **8 处 AI 调用点**：

| 调用场景 | 功能 | 模式 |
|----------|------|------|
| 对话生成 | 流式生成 AI 回复 | SSE 实时流式输出 |
| 字段提取 | 从用户消息中提取结构化数据 | 与对话并行执行 |
| 完成度评估 | 判断信息是否充分可生成报告 | 后台异步 |
| 报告生成 | 生成完整申诉材料 | 流式输出 |
| 行业扩展 | 动态生成行业特定信息收集项 | 触发式 |
| 对话分析 | 进化引擎质量评估 | 30分钟异步 |
| 规则生成 | 从分析结果自动提炼最优规则 | 2小时异步 |
| 知识聚合 | 跨对话模式聚合 | 每日聚合 |

#### 3.2.3 localAI.js — 本地规则引擎

- **零 Token 消耗**：不调用 AI API，基于规则引擎实现基础对话流程
- **16 项信息收集字段**：按 6 个阶段有序收集（业务了解→问题信息→商户信息→企业信息→投诉售后→联系方式）
- **输入校验**：数字字段识别（商户号/身份证后四位/银行卡后四位/手机号）
- **报告 Prompt 构建**：将收集到的信息组装为深度分析报告的 Prompt

#### 3.2.4 knowledgeBase.js — 行业知识库

- **16 个内置成功案例**：覆盖餐饮/电商/教育/游戏/直播/代购/微商等行业
- **12 种违规类型知识**：交易异常、交易纠纷、跨类目、套现、欺诈、分销、赌博、色情、洗钱、内容违规、虚假交易、异地收款
- **智能匹配**：根据用户输入自动匹配最相关的违规类型和案例
- **风险评估引擎**：多维度评分（处罚类型+违规原因+行业+投诉+申诉历史）
- **材料清单生成**：根据行业+违规原因动态生成，每项标注【必需/建议】+ 获取方式

#### 3.2.5 volution.js — AI 自进化引擎 V3

这是系统的**核心竞争力模块**，实现了"越用越聪明"的自我进化能力：

1. **对话分析器**：异步分析对话质量/效率/情绪（20+ 评分维度）
2. **规则生成器**：从分析结果自动提炼对话规则
3. **动态规则加载器**：从 DB 加载活跃规则注入 System Prompt（3分钟缓存）
4. **规则效果评估**：自动升降级（试用→正式/降级/废弃）
5. **AI 自动打标**：分类/难度/用户类型/行为模式标签
6. **知识聚合簇**：跨对话模式聚合/行业知识簇/问题效果评分
7. **自主探索模式**：AI 实验性规则 A/B 测试
8. **熔断器+容错**：组件级健康监控/自动熔断/优雅回退
9. **定时任务**：30分钟分析 / 2小时升降级 / 每日聚合+聚类
10. **配额控制**：每小时最多 30 次分析，防止 API 费用失控

#### 3.2.6 modelHealth.js — 模型健康检测

- **30 分钟定时巡检**：对所有启用的 AI 模型发送最小请求验证可用性
- **故障自动切换**：当活跃模型不可用时，自动切换到健康的备用模型
- **状态分类**：healthy / rate_limited / auth_failed / balance_empty / timeout / error / no_key
- **免费模型回退**：优先回退到免费模型，降低成本

#### 3.2.7 mall.js — 智能商城推荐引擎

- **商品目录感知**：将活跃商品目录注入 AI 对话 System Prompt
- **AI 商品优化**：DeepSeek 自动优化商品描述/标签/受众
- **智能推荐引擎**：基于用户画像 + 对话上下文匹配商品
- **用户兴趣追踪**：从对话中提取用户需求/行业/关键词

#### 3.2.8 db.js — MySQL 数据访问层

- **连接池管理**：mysql2/promise 连接池，支持 keepalive ping（60秒间隔）
- **自动建表**：首次启动自动创建全部 25+ 张表
- **自动迁移**：兼容旧版本表结构，自动添加新列/修改字段类型
- **敏感数据加密**：API Key 等敏感配置字段自动加密存储/解密读取

#### 3.2.9 	okenizer.js — Token 统计与计费

- **精确计算**：使用 js-tiktoken（cl100k_base 编码）与主流模型兼容
- **降级方案**：编码器失败时按字符估算（中文 1.5 token/字，英文 0.3 token/字符）
- **计费公式**：输入 ¥0.001/1K tokens + 输出 ¥0.002/1K tokens，乘以倍率（默认 2x）
- **最低消费**：¥0.01 保底

#### 3.2.10 crypto.js — 加密工具

- **AES-256-GCM**：对称加密，用于加密存储手机号、API Key、支付密钥等
- **SHA-256 HMAC**：单向哈希，用于索引查找（加 ENCRYPT_KEY 防彩虹表攻击）
- **安全特性**：随机 IV（16字节）+ 认证标签（16字节）+ 幂等加密（已加密数据不重复加密）

#### 3.2.11 monitor.js — 🆕 系统监控服务

- **服务器状态监控**：CPU/内存/磁盘使用率实时采集
- **API 调用统计**：按接口/时间段统计请求量、响应时间、错误率
- **告警机制**：异常指标自动告警

#### 3.2.12 payment.js — 🆕 支付系统

- **订单管理**：创建/查询/更新支付订单
- **支付流程**：支持多种支付方式的统一接入
- **对账功能**：订单状态自动同步

#### 3.2.13 backup.js — 🆕 备份管理

- **数据库备份**：支持手动/定时备份 MySQL 数据
- **备份恢复**：从备份文件恢复数据库
- **备份列表**：查看历史备份记录和状态

#### 3.2.14 MVC 分层架构 — 🆕 v2.0 新增

v2.0 引入标准 MVC 分层架构，将业务逻辑从 index.js 中解耦：

| 层级 | 目录 | 职责 |
|------|------|------|
| **控制器层** | controllers/ | 接收请求、参数校验、调用服务层、返回响应 |
| **服务层** | services/ | 核心业务逻辑（申诉进度追踪、重申策略、用户管理） |
| **模型层** | models/ | 数据库操作封装（10个模型，对应核心业务表） |
| **路由层** | routes/ | URL路径到控制器方法的映射 |
| **中间件层** | middleware/ | JWT认证、全局错误处理 |
| **配置层** | config/ | 数据库连接、初始化、种子数据 |
| **工具层** | utils/ | 加密、JSON解析、日志 |

#### 3.2.15 RAG 检索增强生成 — 🆕 v2.0 新增

- **ragService.js**：构建包含知识库检索结果的增强 System Prompt
- **llm.js**：LLM 调用核心封装，统一管理模型调用参数和错误处理
- **知识注入**：将检索到的相关案例、行业知识、用户上下文动态注入到 AI 对话中

---


## 四、数据库设计

系统启动时自动创建全部表结构，无需手动建表或执行 SQL 脚本。

### 4.1 核心业务表

| 表名 | 说明 | 关键字段 |
|------|------|----------|
| users | 用户表 | phone（AES加密）、phone_hash（HMAC索引）、balance、api_mode |
| sessions | 会话表 | user_id、collected_data（JSON）、step、deep_analysis_result |
| messages | 消息表 | session_id、role（user/assistant/admin）、content（MEDIUMTEXT） |
| admins | 管理员表 | username、password（bcrypt 哈希） |
| system_config | 系统配置 | config_key、config_value（敏感字段加密） |

### 4.2 计费与充值表

| 表名 | 说明 | 关键字段 |
|------|------|----------|
| token_usage | Token 用量记录 | user_id、input/output_tokens、cost、type（chat/extract/report等） |
| recharge_orders | 充值订单 | user_id、amount、status（pending/confirmed/rejected） |

### 4.3 申诉业务表

| 表名 | 说明 | 关键字段 |
|------|------|----------|
| success_cases | 成功案例库 | industry、problem_type、strategy、appeal_points |
| appeal_texts | 申诉文案 | session_id、5段文案、appeal_status、user_feedback |
| field_change_log | 字段变更记录 | session_id、field_key、old_value、new_value、change_source |

### 4.4 AI 模型与进化表

| 表名 | 说明 | 关键字段 |
|------|------|----------|
| ai_models | AI 模型管理 | provider、model_name、endpoint、api_key、is_active、health_status |
| ai_rules | AI 进化规则库 | category、content、status（draft/trial/active/deprecated）、effectiveness_score |
| conversation_analyses | 对话分析结果 | session_id、20+评分维度 |
| conversation_tags | 自动打标分类 | difficulty、outcome、user_type、quality |
| knowledge_clusters | 知识聚合簇 | cluster_type（industry/violation/success_factor）、pattern |
| learning_metrics | 每日学习指标 | completion_rate、satisfaction、rule_changes |
| rule_change_log | 规则审计日志 | rule_id、action、before/after |
| engine_health | 引擎健康/熔断器 | component、status、error_count |
| exploration_experiments | A/B测试记录 | rule_id、experiment_group、metrics |

### 4.5 商城与名片表

| 表名 | 说明 | 关键字段 |
|------|------|----------|
| mall_products | 智能商城商品 | name、price、category、ai_description |
| contact_cards | 技术人员名片 | name、phone、wechat、is_active |
| orders | 商城订单 | order_no、user_id、product_id、status |
| deepseek_accounts | DeepSeek账号池 | api_key、balance、is_active |

---

## 五、API 接口文档

### 5.1 用户端接口

#### 认证相关

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/user/register | 用户注册（手机号+昵称+密码） |
| POST | /api/user/login | 用户登录，返回 JWT Token |

#### AI 对话

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/chat/stream | SSE 流式 AI 对话（核心接口） |
| GET | /api/sessions/:id/info | 获取会话已收集信息 |
| PUT | /api/sessions/:id/field | 手动修改某个字段值 |

#### 分析与申诉

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/sessions/:id/deep-analysis | 获取/触发深度分析报告 |
| POST | /api/sessions/:id/generate-appeal-text | 一键生成申诉文案（5段） |
| POST | /api/sessions/:id/appeal-feedback | 标记申诉结果（通过/驳回） |
| GET | /api/sessions/:id/appeal-progress | 🆕 获取申诉进度状态 |
| POST | /api/sessions/:id/resubmit-strategy | 🆕 获取驳回后智能重申策略 |
| POST | /api/sessions/:id/generate-complaint-reply | 🆕 生成投诉回复话术 |
| GET | /api/sessions/:id/appeal-guide | 🆕 获取申诉指导方案 |

#### 用户中心

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/recharge | 用户发起充值 |
| GET | /api/user/:id/usage | 个人消费明细 |
| GET | /api/user/:id/appeal-records | 🆕 用户申诉记录列表 |
| GET | /api/contact-card | 获取技术人员名片（公开） |

### 5.2 管理端接口

#### 仪表盘与统计

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/admin/login | 管理员登录 |
| GET | /api/admin/stats | 仪表盘统计（用户/会话/利润/模型健康/Token） |
| GET | /api/admin/appeal-stats | 申诉成功率统计（按行业/按类型） |
| GET | /api/admin/token-usage | Token 消耗统计 |

#### 用户与会话管理

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/admin/users | 用户列表 |
| DELETE | /api/admin/users/:id | 删除用户 |
| PUT | /api/admin/users/:id/balance | 调整用户余额 |
| GET | /api/admin/sessions | 会话列表 |
| PUT | /api/admin/recharge-orders/:id/confirm | 确认充值 |

#### AI 模型与进化管理

| 方法 | 路径 | 说明 |
|------|------|------|
| GET/POST | /api/admin/ai-models/* | AI 模型 CRUD + 健康检测 |
| GET/POST | /api/admin/ai-rules/* | AI 规则管理（审批/编辑） |
| GET | /api/admin/evolution/* | 进化引擎数据（分析/标签/聚类） |

#### 系统配置

| 方法 | 路径 | 说明 |
|------|------|------|
| PUT | /api/admin/system-config | 系统配置（AI参数/技术名片/费用倍率） |
| POST/PUT/DELETE | /api/admin/cases/* | 成功案例库 CRUD |

> 完整 100+ API 端点详见源码 server/index.js

---

## 六、核心业务流程

### 6.1 用户对话流程

```
用户注册/登录
    ↓
选择 API 模式（官方模式 / 自定义API Key）
    ↓
进入对话页面，AI 发送欢迎消息
    ↓
用户描述问题（自然语言，如"我做餐饮的，商户号被冻结了"）
    ↓
┌─────────────────────────────────────┐
│  AI 对话引擎（并行处理）             │
│  ├─ 流式生成回复（SSE实时输出）      │
│  ├─ DeepSeek 提取结构化字段          │
│  ├─ 行业识别 → 触发动态字段扩展      │
│  └─ 完成度评估                       │
└─────────────────────────────────────┘
    ↓
左侧信息面板实时更新已收集字段
    ↓
16项基础信息 + 行业动态字段收集完毕
    ↓
┌─────────────────────────────────────┐
│  深度分析引擎                        │
│  ├─ 风控逆向推演（站在微信角度）     │
│  ├─ 四层证据链设计                   │
│  ├─ 智能风险评估（成功率预估）       │
│  ├─ 个性化材料清单                   │
│  └─ 95017电话话术                    │
└─────────────────────────────────────┘
    ↓
一键生成申诉文案（5段专业文案）
    ↓
用户复制提交申诉 → 反馈结果（通过/驳回）
    ↓
进化引擎学习本次对话，优化后续服务
```

### 6.2 信息收集六阶段

| 阶段 | 收集内容 | 字段数 |
|------|----------|--------|
| 第一阶段：业务了解 | 业务类型、经营模式 | 2 |
| 第二阶段：问题信息 | 处罚类型、违规原因 | 2 |
| 第三阶段：商户信息 | 商户号、商户名称 | 2 |
| 第四阶段：企业信息 | 公司全称、统一社会信用代码、法人姓名、身份证后四位 | 4 |
| 第五阶段：投诉售后 | 投诉情况、退款政策 | 2 |
| 第六阶段：联系方式 | 开户银行、银行卡后四位、联系电话、申诉历史 | 4 |

> 识别到行业后，系统会自动追加行业特定字段（如餐饮→食品安全许可证、游戏→版号）

### 6.3 AI 反幻觉四重防线

| 层级 | 机制 | 说明 |
|------|------|------|
| 第一层 | 对话 Prompt | System Prompt 明确禁止编造信息 |
| 第二层 | 提取 Prompt | 提取时只允许从用户原文中提取，无法确认的标记为空 |
| 第三层 | 报告 Prompt | 报告生成时只能使用已收集的数据 |
| 第四层 | 服务端校验 | 后端对提取结果做格式/逻辑校验 |

### 6.4 计费模式

| 模式 | 说明 | 扣费方式 |
|------|------|----------|
| 官方模式 | 使用平台配置的 AI API Key | 按 Token 消耗扣用户余额（倍率可调） |
| 自定义模式 | 用户填入自己的 API Key | 不扣平台余额，直接使用用户的 Key |

计费公式：费用 = (输入Token/1000 x 0.001 + 输出Token/1000 x 0.002) x 倍率

每条消息实时显示：输入 Token、输出 Token、费用金额。

---

## 七、安全机制

### 7.1 数据安全

| 机制 | 实现 | 保护对象 |
|------|------|----------|
| AES-256-GCM 加密 | crypto.js | 手机号、API Key、支付密钥等敏感数据 |
| SHA-256 HMAC 哈希 | crypto.js | 手机号索引查找（不可逆，防彩虹表） |
| bcryptjs 哈希 | 用户注册 | 用户密码（不可逆） |

### 7.2 接口安全

| 机制 | 实现 | 说明 |
|------|------|------|
| JWT 认证 | jsonwebtoken | 用户端和管理端分离的 Token 体系，24小时过期 |
| 全局限速 | express-rate-limit | 100次/分钟，防止接口滥用 |
| 聊天限速 | 独立配置 | 20次/分钟，防止 AI 接口被刷 |
| 安全头 | helmet | HSTS、X-Frame-Options、X-Content-Type-Options 等 |
| CORS 控制 | cors 中间件 | 生产环境限制允许的跨域来源 |
| 信任代理 | trust proxy | 支持 Nginx 反向代理获取真实 IP |

### 7.3 密钥管理

- ENCRYPT_KEY：64位十六进制字符串（32字节），用于 AES-256 加密
- JWT_SECRET：随机字符串，用于 JWT 签名
- 两个密钥均通过 .env 环境变量配置，不硬编码在代码中
- 启动时检测 JWT_SECRET 是否配置，未配置则打印安全警告

---

## 八、项目文件结构

```
merchant-appeal/
├── public/                              # 静态资源
│   └── vite.svg                         # Vite 默认图标
├── src/                                 # 前端源码（React 18 + TailwindCSS）
│   ├── components/                      # UI 组件（21个）
│   │   ├── ChatMessage.jsx              # 聊天消息（Markdown渲染+延迟/Token显示）
│   │   ├── InfoPanel.jsx                # 信息收集面板（9组分类+动态扩展）
│   │   ├── AIAnalysisPanel.jsx          # AI 深度分析面板
│   │   ├── AnalysisVisualView.jsx       # 分析结果可视化
│   │   ├── AppealGuidePanel.jsx         # 🆕 申诉指导面板（流程+进度+反馈+重申）
│   │   ├── AppealTextPanel.jsx          # 申诉文案面板（进度跟踪+反馈）
│   │   ├── ComplaintDocPanel.jsx        # 🆕 投诉材料整理面板
│   │   ├── ReportCard.jsx              # 申诉报告卡片
│   │   ├── TokenPanel.jsx              # Token消耗可视化
│   │   ├── MallPanel.jsx               # 智能商城面板
│   │   ├── QualityDashboard.jsx        # 质量评分仪表盘
│   │   ├── EvolutionPanel.jsx          # AI进化引擎面板
│   │   ├── UserCenter.jsx              # 用户中心（余额/充值/用量/申诉记录）
│   │   ├── UserAvatar.jsx              # 🆕 用户头像组件
│   │   ├── ContactCardsPanel.jsx       # 🆕 联系人名片面板
│   │   ├── AIActivityPanel.jsx         # 🆕 AI活动监控面板
│   │   ├── AIModelsPanel.jsx           # 🆕 AI模型管理面板
│   │   ├── MonitorPanel.jsx            # 🆕 系统监控面板
│   │   ├── BackupPanel.jsx             # 🆕 备份管理面板
│   │   ├── TypingIndicator.jsx         # AI输入动画
│   │   └── ErrorBoundary.jsx           # 错误边界
│   ├── pages/                           # 页面级组件（4个）
│   │   ├── ChatPage.jsx                # 主对话页面（智能快捷回复+对话导出）
│   │   ├── AdminPage.jsx               # 管理后台（仪表盘+会话+用户+设置+进化+监控）
│   │   ├── AdminLogin.jsx              # 管理员登录页
│   │   └── ServicePage.jsx             # 🆕 客服服务页面
│   ├── App.jsx                          # 路由配置（React Router 6）
│   ├── main.jsx                         # 应用入口
│   └── index.css                        # 全局样式（TailwindCSS 指令）
├── server/                              # 后端源码（Express + MVC架构）
│   ├── index.js                         # Express 主入口（100+ API路由）
│   ├── app.js                           # 🆕 Express 应用初始化
│   ├── ai.js                            # 多模型AI调用层（System Prompt+动态注入）
│   ├── localAI.js                       # 本地规则引擎（零Token消耗）
│   ├── knowledgeBase.js                 # 行业知识库+违规类型+案例
│   ├── evolution.js                     # AI自进化引擎V3
│   ├── modelHealth.js                   # 模型健康检测+自动切换
│   ├── mall.js                          # 智能商城推荐引擎
│   ├── db.js                            # MySQL数据访问层（25+表）
│   ├── tokenizer.js                     # Token统计与计费
│   ├── monitor.js                       # 🆕 系统监控服务
│   ├── payment.js                       # 🆕 支付系统
│   ├── backup.js                        # 🆕 备份管理
│   ├── controllers/                     # 🆕 MVC控制器层（5个）
│   │   ├── aiController.js              #   AI对话控制器
│   │   ├── appealController.js          #   申诉业务控制器
│   │   ├── sessionController.js         #   会话管理控制器
│   │   ├── userController.js            #   用户管理控制器
│   │   └── rechargeController.js        #   充值管理控制器
│   ├── models/                          # 🆕 数据模型层（10个）
│   │   ├── Appeal.js / Session.js / User.js / Message.js
│   │   ├── Order.js / Product.js / TokenUsage.js
│   │   ├── RechargeOrder.js / KnowledgeBase.js / SystemConfig.js
│   ├── services/                        # 🆕 业务服务层（4个）
│   │   ├── appealService.js / sessionService.js
│   │   └── userService.js / messageService.js
│   ├── routes/                          # 🆕 路由层（6个）
│   │   ├── index.js / aiRoutes.js / appealRoutes.js
│   │   └── sessionRoutes.js / userRoutes.js / paymentRoutes.js
│   ├── middleware/                       # 🆕 中间件层
│   │   ├── auth.js                      #   JWT认证
│   │   └── errorHandler.js              #   全局错误处理
│   ├── config/                          # 🆕 配置层
│   │   ├── database.js / initDb.js / seedData.js
│   ├── ai/                              # 🆕 AI子模块
│   │   ├── core/llm.js                  #   LLM调用核心
│   │   └── rag/ragService.js            #   RAG检索增强生成
│   └── utils/                           # 🆕 工具库
│       ├── crypto.js / jsonHelper.js / logger.js
├── .env.example                         # 环境变量模板
├── .gitignore                           # Git忽略规则
├── DEPLOY.md                            # 生产部署指南（宝塔面板）
├── PROJECT_AUDIT.md                     # 🆕 项目审计报告
├── LICENSE                              # MIT 开源协议
├── README.md                            # 项目 README
├── package.json                         # v2.0.0
└── vite.config.js                       # Vite 构建配置（代理+代码分割）
```

---

## 九、环境配置说明

### 9.1 环境变量（.env）

```env
# 数据库配置
DB_HOST=localhost          # MySQL 主机地址
DB_PORT=3306               # MySQL 端口
DB_USER=root               # 数据库用户名
DB_PASSWORD=your_password  # 数据库密码
DB_NAME=merchant_appeal    # 数据库名称
DB_CONNECTION_LIMIT=10     # 连接池大小

# 安全密钥（部署前必须修改！）
ENCRYPT_KEY=64位十六进制字符串    # AES-256 加密密钥
JWT_SECRET=随机字符串              # JWT 签名密钥
JWT_EXPIRES_IN=24h                 # JWT 过期时间

# 服务器配置
PORT=3001                  # 后端服务端口
NODE_ENV=production        # 运行环境（development/production）
CORS_ORIGINS=*             # 允许跨域的域名（生产环境应指定具体域名）

# 速率限制
RATE_LIMIT_MAX=100         # 全局每分钟最大请求数
CHAT_RATE_LIMIT_MAX=20     # 聊天接口每分钟最大请求数
```

### 9.2 密钥生成方法

```bash
# 生成 ENCRYPT_KEY（64位十六进制 = 32字节）
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# 生成 JWT_SECRET
node -e "console.log(require('crypto').randomBytes(48).toString('hex'))"
```

### 9.3 Vite 开发配置

- 开发服务器端口：5173
- API 代理：/api/* 请求自动代理到 http://localhost:3001
- 构建输出目录：dist/
- 代码分割：react 相关库和 html2canvas 分别打包

---

## 十、快速开始

### 10.1 环境要求

- Node.js 18+
- MySQL 5.7+ 或 8.0+
- DeepSeek API Key（从 https://platform.deepseek.com 获取）

### 10.2 安装步骤

```bash
# 1. 克隆项目
git clone https://github.com/aiyangdie/merchant-appeal.git
cd merchant-appeal

# 2. 安装依赖
npm install

# 3. 配置环境变量
cp .env.example .env
# 编辑 .env 填写数据库密码和安全密钥

# 4. 开发模式（前后端同时启动）
npm run dev

# 或者生产模式
npm run build    # 构建前端
npm run start    # 启动服务器
```

### 10.3 NPM 脚本说明

| 命令 | 说明 |
|------|------|
| npm run dev | 同时启动前端开发服务器（Vite:5173）和后端（Express:3001） |
| npm run dev:client | 仅启动前端开发服务器 |
| npm run dev:server | 仅启动后端服务器（带 --watch 自动重启） |
| npm run build | 使用 Vite 构建前端到 dist/ |
| npm run start | 生产模式启动后端（托管 dist/ 静态文件） |

### 10.4 访问地址

- 用户端：http://localhost:3001（生产）或 http://localhost:5173（开发）
- 管理后台：http://localhost:3001/admin
- 默认管理员：admin / admin123（首次登录后务必修改密码）

### 10.5 配置 AI

登录管理后台 → 系统配置 → 填入 DeepSeek API Key → 保存。
未配置 API Key 时系统会使用本地规则引擎（localAI），功能受限但不消耗 Token。

---

## 十一、生产部署

### 11.1 部署架构

```
互联网用户 → Nginx（SSL + 静态文件） → Node.js:3001（Express API） → MySQL 8.0
```

### 11.2 部署步骤概要

1. 服务器：Linux + Node.js 18+ + MySQL 8.0 + Nginx
2. 上传项目文件（dist/ + server/ + package.json + .env）
3. 安装生产依赖：npm install --production
4. Nginx 配置：托管 dist/ 静态文件 + 反代 /api/ 到 Node:3001
5. PM2 守护进程：pm2 start server/index.js --name merchant-appeal
6. SSL 证书：Let's Encrypt 免费证书
7. 安全加固：修改默认密码、配置强密钥、限制 CORS

### 11.3 Nginx 关键配置

- 前端静态文件：root 指向 dist/ 目录
- API 反向代理：/api/ 路径代理到 http://127.0.0.1:3001
- SPA 路由：所有非文件请求返回 index.html
- 静态资源缓存：js/css/图片等 30天缓存
- SSE 支持：proxy_read_timeout 设为 120s

> 详细部署指南参见 DEPLOY.md（宝塔面板一站式部署教程）

---

## 十二、管理后台功能

### 12.1 仪表盘

- 用户总数、今日新增、活跃会话数
- 充值收入、AI 成本、毛利润、利润率
- 模型健康状态实时监控
- Token 消耗趋势图

### 12.2 用户管理

- 查看所有注册用户列表
- 调整用户余额（充值/扣款）
- 删除用户

### 12.3 会话监控

- 查看所有对话记录
- 管理员可人工回复用户消息
- 查看会话收集的结构化数据

### 12.4 充值审核

- 查看待审核充值订单
- 确认/拒绝充值

### 12.5 案例库管理

- CRUD 成功申诉案例
- 案例信息：行业、处罚类型、违规原因、难度、策略、申诉要点

### 12.6 AI 模型管理

- 添加/编辑/删除 AI 模型
- 设置活跃模型
- 一键健康检测
- 查看模型响应时间和状态

### 12.7 AI 进化引擎

- 查看对话分析结果（20+维度评分）
- 管理 AI 规则（审批/编辑/升降级）
- 查看自动打标统计
- 知识聚合簇可视化
- A/B 测试实验数据

### 12.8 系统配置

- AI 参数：API Key、模型选择、温度参数
- 费用倍率设置
- 技术人员名片配置
- CORS 和安全配置

### 12.9 🆕 系统监控（v2.0）

- 服务器状态：CPU/内存/磁盘使用率
- API 调用统计：请求量、响应时间、错误率
- AI 活动监控：模型调用频次、Token消耗趋势

### 12.10 🆕 备份管理（v2.0）

- 手动/定时数据库备份
- 备份文件列表和状态
- 一键恢复功能

---

## 十三、依赖包说明

### 13.1 生产依赖

| 包名 | 版本 | 用途 |
|------|------|------|
| react | 18.3 | 前端 UI 框架 |
| react-dom | 18.3 | React DOM 渲染 |
| react-router-dom | 6.28 | 前端路由 |
| express | 4.21 | 后端 Web 框架 |
| mysql2 | 3.16 | MySQL 数据库驱动（Promise API） |
| jsonwebtoken | 9.0 | JWT Token 生成与验证 |
| bcryptjs | 3.0 | 密码哈希加密 |
| helmet | 8.1 | HTTP 安全头 |
| cors | 2.8 | 跨域资源共享 |
| express-rate-limit | 8.2 | 请求速率限制 |
| dotenv | 17.2 | 环境变量加载 |
| uuid | 10.0 | UUID 生成（会话ID） |
| js-tiktoken | 1.0 | Token 计数（OpenAI兼容编码） |
| html2canvas | 1.4 | 前端截图功能 |

### 13.2 开发依赖

| 包名 | 版本 | 用途 |
|------|------|------|
| vite | 6.0 | 前端构建工具 |
| @vitejs/plugin-react | 4.3 | Vite React 插件 |
| tailwindcss | 3.4 | 原子化 CSS 框架 |
| postcss | 8.4 | CSS 后处理器 |
| autoprefixer | 10.4 | CSS 自动前缀 |
| concurrently | 9.1 | 并行运行多个命令 |
| pptxgenjs | 4.0 | PPT 生成（脚本用） |
| canvas | 3.2 | Node.js Canvas（脚本用） |

---

## 十四、常见问题

### Q1: 页面空白
- 检查 dist/ 文件夹是否存在（需先执行 npm run build）
- 检查 Nginx root 路径是否指向 dist/
- 重启 Nginx

### Q2: 接口 502 Bad Gateway
- 检查 Node.js 进程是否运行：pm2 list
- 检查 .env 中端口配置是否正确
- 查看日志：pm2 logs merchant-appeal

### Q3: AI 不回复
- 管理后台检查 DeepSeek API Key 是否已配置
- 检查用户余额是否 > 0
- 查看模型健康状态是否为 healthy

### Q4: 数据库连接失败
- 检查 MySQL 服务是否运行
- 检查 .env 中 DB_* 配置是否正确
- 确认数据库用户权限

### Q5: Token 费用异常
- 管理后台检查费用倍率设置
- 查看 Token 用量面板确认消耗明细

### Q6: 未配置 API Key 时的降级方案
- 系统自动使用本地规则引擎（localAI.js）
- 基础对话流程正常，但无法进行深度分析和智能提取
- 建议尽快配置 AI API Key 以获得完整功能

---

## 十五、开源协议

本项目采用 MIT License 开源协议，允许自由使用、修改和商用。

版权所有 (c) 2026 aiyang

---

> 本文档由项目源码分析自动生成，如有疑问请参考 README.md 和 DEPLOY.md，或提交 Issue。