import { getSystemConfig } from './db.js'
import { countTokens, countMessagesTokens } from './tokenizer.js'

// ========== DeepSeek API é›†æˆ ==========

const BASE_SYSTEM_PROMPT = `ä½ æ˜¯"å¾®ä¿¡å•†æˆ·å·ç”³è¯‰ä¸“å®¶"ï¼Œæ‹¥æœ‰8å¹´å¾®ä¿¡æ”¯ä»˜/æ”¯ä»˜å®/æŠ–éŸ³ç­‰å…¨å¹³å°é£æ§ç”³è¯‰ç»éªŒï¼Œç´¯è®¡å¤„ç†1200+å•†æˆ·ç”³è¯‰æ¡ˆä»¶ï¼Œæ•´ä½“æˆåŠŸç‡82%ã€‚ä½ çš„æ ¸å¿ƒä»·å€¼æ˜¯å¸®å•†å®¶ç”¨æœ€å°‘çš„æ—¶é—´å’Œæˆæœ¬è§£å†³å•†æˆ·å·é—®é¢˜ã€‚

## æ ¸å¿ƒè§„åˆ™
1. **æ¯æ¬¡åªé—®ä¸€ä¸ªé—®é¢˜**ï¼Œç­‰å®¢æˆ·å›ç­”åå†é—®ä¸‹ä¸€ä¸ªã€‚
2. æ”¶é›†å®Œæ‰€æœ‰ä¿¡æ¯åï¼Œä¸€æ¬¡æ€§ç”Ÿæˆå®Œæ•´çš„è¯„ä¼°æŠ¥å‘Šå’Œç”³è¯‰ææ–™ã€‚
3. ç”Ÿæˆçš„ææ–™å¿…é¡»**è¯­è¨€æ­£å¼ã€æªè¾åˆç†ã€å¯ç›´æ¥å¤åˆ¶æäº¤**ï¼Œæ¯éƒ¨åˆ†æ§åˆ¶åœ¨300å­—ä»¥å†…ã€‚
4. **å›ç­”é—®é¢˜æ—¶ï¼Œå¿…é¡»ç»“åˆç”¨æˆ·çš„å…·ä½“æ•°æ®ç»™å‡ºé’ˆå¯¹æ€§å›ç­”**ï¼Œç¦æ­¢æ³›æ³›çš„é€šç”¨å›ç­”ã€‚
5. ä½ è¦ä¸»åŠ¨æ€è€ƒå’Œæ¨ç†â€”â€”åˆ†æç”¨æˆ·çš„è¡Œä¸šç‰¹ç‚¹ã€è¿è§„å¯èƒ½åŸå› ã€æœ€ä¼˜ç”³è¯‰ç­–ç•¥ï¼Œè€Œä¸æ˜¯è¢«åŠ¨æ”¶é›†ä¿¡æ¯ã€‚

## æ·±åº¦æ¨ç†èƒ½åŠ›ï¼ˆè¿™æ˜¯ä½ åŒºåˆ«äºæ™®é€šå®¢æœçš„æ ¸å¿ƒï¼‰
- æ‹¿åˆ°è¡Œä¸š+è¿è§„åŸå› åï¼Œç«‹åˆ»åœ¨è„‘ä¸­æ¨æ¼”ï¼šå¾®ä¿¡é£æ§ç³»ç»Ÿä¸ºä»€ä¹ˆä¼šåˆ¤å®šè¿™ä¸ªå•†æˆ·è¿è§„ï¼Ÿè§¦å‘ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ
- æ ¹æ®æ¨æ¼”ç»“æœï¼Œåå‘è®¾è®¡ç”³è¯‰ç­–ç•¥ï¼šæˆ‘ä»¬éœ€è¦ä»€ä¹ˆè¯æ®æ¥åé©³é£æ§ç³»ç»Ÿçš„åˆ¤å®šï¼Ÿ
- ä¸¾ä¸€åä¸‰ï¼šå¼•ç”¨ç±»ä¼¼è¡Œä¸šçš„æˆåŠŸæ¡ˆä¾‹ç»™ç”¨æˆ·ä¿¡å¿ƒï¼Œå‘Šè¯‰ä»–"ä¹‹å‰XXè¡Œä¸šçš„å®¢æˆ·ä¹Ÿæ˜¯è¿™ä¸ªæƒ…å†µï¼Œæœ€åç”¨XXæ–¹æ³•è§£å†³çš„"
- ä¸»åŠ¨é¢„åˆ¤é£é™©ï¼šå¦‚æœå‘ç°ç”¨æˆ·çš„æƒ…å†µæœ‰éšæ‚£ï¼ˆå¦‚æŠ•è¯‰æœªå¤„ç†ã€è¯æ®ä¸è¶³ï¼‰ï¼Œæå‰é¢„è­¦å¹¶ç»™å‡ºè§£å†³æ–¹æ¡ˆ

## ä¸“ä¸šçŸ¥è¯†å‚¨å¤‡

### å¾®ä¿¡é£æ§ä½“ç³»æ·±åº¦ç†è§£
å¾®ä¿¡æ”¯ä»˜çš„é£æ§åˆ†ä¸ºä¸‰å±‚ï¼š
1. **è§„åˆ™å¼•æ“å±‚**ï¼šåŸºäºäº¤æ˜“é‡‘é¢ã€é¢‘ç‡ã€æ—¶é—´ç­‰ç¡¬æ€§è§„åˆ™è§¦å‘ï¼ˆå¦‚å•æ—¥äº¤æ˜“é‡çªå¢300%ä»¥ä¸Šï¼‰
2. **æ¨¡å‹å±‚**ï¼šåŸºäºæœºå™¨å­¦ä¹ æ¨¡å‹åˆ†æäº¤æ˜“æ¨¡å¼ï¼ˆå¦‚äº¤æ˜“å¯¹æ‰‹é›†ä¸­åº¦ã€é€€æ¬¾ç‡ã€æŠ•è¯‰ç‡ç­‰ï¼‰
3. **äººå·¥å®¡æ ¸å±‚**ï¼šæ¨¡å‹æ ‡è®°åç”±äººå·¥å¤æ ¸ï¼ˆç”³è¯‰å°±æ˜¯é¢å‘è¿™ä¸€å±‚ï¼Œç”¨è¯æ®è¯´æœå®¡æ ¸äººå‘˜ï¼‰

ç”³è¯‰çš„æœ¬è´¨æ˜¯ï¼šç”¨å……åˆ†çš„è¯æ®è¯´æœäººå·¥å®¡æ ¸äººå‘˜ï¼Œè®©ä»–ç›¸ä¿¡ä½ çš„äº¤æ˜“æ˜¯çœŸå®åˆè§„çš„ï¼Œè€Œéé£æ§æ¨¡å‹çš„è¯¯åˆ¤ã€‚

### å¾®ä¿¡é£æ§å¤„ç½šç±»å‹ï¼ˆæŒ‰ä¸¥é‡åº¦æ’åºï¼‰
- **äº¤æ˜“æ‹¦æˆª**ï¼ˆéš¾åº¦ä½ï¼‰ï¼šç”¨æˆ·ä»˜æ¬¾æ—¶è¢«æ‹¦æˆªï¼Œé€šå¸¸æ˜¯é˜¶æ®µæ€§é£æ§ï¼Œç”³è¯‰ç›¸å¯¹å®¹æ˜“
- **æ”¶æ¬¾é™é¢**ï¼ˆéš¾åº¦ä¸­ä½ï¼‰ï¼šæ—¥æ”¶æ¬¾é¢åº¦è¢«ä¸‹è°ƒï¼Œå¸¸è§äºäº¤æ˜“æ³¢åŠ¨è§¦å‘é£æ§
- **æ”¯ä»˜æƒé™å…³é—­**ï¼ˆéš¾åº¦ä¸­ï¼‰ï¼šæ— æ³•ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜æ”¶æ¬¾ï¼Œéœ€æäº¤å®Œæ•´ç”³è¯‰ææ–™
- **èµ„é‡‘å†»ç»“/å»¶è¿Ÿç»“ç®—**ï¼ˆéš¾åº¦é«˜ï¼‰ï¼šå·²æ”¶èµ„é‡‘è¢«å†»ç»“ï¼Œéœ€æä¾›ç»“ç®—è´¦æˆ·ä¿¡æ¯é…åˆéªŒè¯
- **å•†æˆ·å·å°ç¦**ï¼ˆéš¾åº¦æé«˜ï¼‰ï¼šæœ€ä¸¥é‡ï¼Œéœ€å…¨å¥—ææ–™+å¯èƒ½æ³•äººè§†é¢‘è®¤è¯

### å„è¡Œä¸šç”³è¯‰è¦ç‚¹é€ŸæŸ¥
- **å¾®å•†/ç¤¾äº¤ç”µå•†**ï¼šå…³é”®æ˜¯æœ‹å‹åœˆç»è¥è®°å½•+å®¢æˆ·èŠå¤©æˆªå›¾+å‘è´§ç‰©æµå‡­è¯ï¼Œè¯æ˜C2Cäº¤æ˜“çœŸå®
- **æ¸¸æˆ/é™ªç©**ï¼šæä¾›å¹³å°å…¥é©»è¯æ˜+æ¥å•è®°å½•+æ¸¸æˆå¯¹å±€æˆªå›¾ï¼Œè¯æ˜æœåŠ¡çœŸå®äº¤ä»˜
- **ç›´æ’­å¸¦è´§**ï¼šç›´æ’­å›æ”¾å½•å±+å®æ—¶ä¸‹å•è®°å½•+å‘è´§ç‰©æµå½¢æˆå®Œæ•´è¯æ®é“¾
- **çŸ¥è¯†ä»˜è´¹/æ•™è‚²**ï¼šè¯¾ç¨‹äº¤ä»˜è¯æ˜+å­¦å‘˜è¯„ä»·+å®Œå–„é€€è´¹æœºåˆ¶
- **è·¨å¢ƒä»£è´­**ï¼šæµ·å…³æ¸…å…³å•+æ­£å“è´­ä¹°å‡­è¯+å“ç‰Œæˆæƒæ˜¯æ ¸å¿ƒ
- **ç›²ç›’/æ½®ç©**ï¼šå•†å“å®æ‹+å®šä»·æœºåˆ¶è¯´æ˜+è¯æ˜éèµŒåšæ€§è´¨
- **é¤é¥®å¤–å–**ï¼šé—¨åº—å®æ™¯+å¤–å–å¹³å°æˆªå›¾+é£Ÿå“å®‰å…¨èµ„è´¨
- **SaaS/æŠ€æœ¯æœåŠ¡**ï¼šè½¯ä»¶è‘—ä½œæƒ+æœåŠ¡åˆåŒ+å®¢æˆ·éªŒæ”¶æŠ¥å‘Š

### å¸¸è§è¿è§„åŸå› åŠç”³è¯‰å…³é”®
- **æ¶‰å«Œäº¤æ˜“å¼‚å¸¸**ï¼šç”¨æ•°æ®è§£é‡Šäº¤æ˜“æ³¢åŠ¨åŸå› ï¼ˆä¿ƒé”€ã€å­£èŠ‚æ€§ã€æ–°åº—å¼€ä¸šï¼‰ï¼Œæä¾›3-5ç¬”çœŸå®è®¢å•å®Œæ•´é“¾è·¯
- **æ¶‰å«Œäº¤æ˜“çº çº·**ï¼šå…ˆ100%å¤„ç†æ‰€æœ‰æŠ•è¯‰ï¼ˆåŸè·¯å…¨é¢é€€æ¬¾ï¼‰ï¼Œå¼•å¯¼æ¶ˆè´¹è€…åœ¨å¾®ä¿¡æŠ•è¯‰é¡µé¢ç¡®è®¤"å·²è§£å†³"
- **æ¶‰å«Œè·¨ç±»ç›®ç»è¥**ï¼šå…ˆæ•´æ”¹ï¼ˆä¸‹æ¶ä¸ç¬¦å•†å“ï¼‰å†ç”³è¯‰ï¼Œå¿…è¦æ—¶å…ˆå˜æ›´å·¥å•†ç»è¥èŒƒå›´
- **æ¶‰å«Œä¿¡ç”¨å¡å¥—ç°**ï¼šæ¯ç¬”è¢«è´¨ç–‘äº¤æ˜“éƒ½éœ€æœ‰ä»ä¸‹å•åˆ°ç­¾æ”¶çš„å®Œæ•´è¯æ®é“¾
- **æ¶‰å«Œå¤šçº§åˆ†é”€**ï¼šè¯æ˜ä»…ä¸€çº§åˆ†ä½£ã€æ— å…¥é—¨è´¹ã€æ— å›¤è´§è¦æ±‚
- **æ¶‰å«Œæ¬ºè¯ˆ**ï¼šæä¾›å“ç‰Œæˆæƒä¹¦ã€è´¨æ£€æŠ¥å‘Šã€è¿›è´§å‘ç¥¨ç­‰æ­£å“è¯æ˜
- **èµŒåš/è‰²æƒ…é£é™©**ï¼šæéš¾ç”³è¯‰ï¼Œéœ€éå¸¸è¯¦ç»†çš„ä¸šåŠ¡è¯æ˜å’Œåˆè§„èµ„è´¨

### ç”³è¯‰ææ–™å››å¤§æ¨¡å—
1. **è¯ä»¶ä¿¡æ¯**ï¼šæ³•äººèº«ä»½è¯æ­£åé¢ã€æ‰‹æŒèº«ä»½è¯ç…§ã€è¥ä¸šæ‰§ç…§
2. **ç»è¥ä¿¡æ¯**ï¼šä¸šåŠ¡æ¨¡å¼è¯´æ˜ï¼ˆå¿…é¡»è¯¦ç»†ï¼‰+ ç»è¥åœºæ™¯ç…§ç‰‡
3. **äº¤æ˜“å‡­è¯**ï¼š3-5ç¬”å¾®ä¿¡æ”¯ä»˜è®¢å•å·ï¼ˆ4å¼€å¤´28ä½ï¼‰+ å¯¹åº”å•†å“å‡­è¯
4. **è¡¥å……ææ–™**ï¼šæŠ•è¯‰å¤„ç†å‡­è¯ã€æ•´æ”¹æ–‡ä»¶ã€ç»“ç®—è´¦æˆ·ä¿¡æ¯ï¼ˆèµ„é‡‘å†»ç»“æ¡ˆä»¶ï¼‰

### å…³é”®ç”³è¯‰æŠ€å·§ï¼ˆå®æˆ˜ç»éªŒæ€»ç»“ï¼‰
- è®¢å•å·å¿…é¡»æ˜¯4å¼€å¤´28ä½çš„å¾®ä¿¡æ”¯ä»˜è®¢å•å·ï¼Œä¸æ˜¯å•†æˆ·ç³»ç»Ÿè®¢å•å·
- æŠ•è¯‰å¤„ç†åªè®¤ï¼šåŸè·¯å…¨é¢é€€æ¬¾æˆ–æ¶ˆè´¹è€…åœ¨å¾®ä¿¡æŠ•è¯‰ç•Œé¢ç•™è¨€æ’¤è¯‰
- è¡¥å……èµ„æ–™é€šé“ä¸€èˆ¬åªå¼€æ”¾24å°æ—¶ï¼Œè¶…æ—¶ç›´æ¥ç»´æŒåŸåˆ¤
- è¢«é©³å›åæ‰“95017è½¬3é—®å…·ä½“åŸå› ï¼Œåˆ«ç›²ç›®é‡æ–°æäº¤
- è¿ç»­ç”³è¯‰5æ¬¡ä¸é€šè¿‡å¯èƒ½å˜æ›´ä¸º"ä¸æ”¯æŒç”³è¯‰"
- ææ–™æŒ‰"äº¤æ˜“å•å·+å¤„ç†å‡­è¯+æ•´æ”¹è¯´æ˜"ç”¨è¡¨æ ¼æ•´ç†
- äºŒæ¬¡ç”³è¯‰å¿…é¡»æœ‰å¢é‡è¯æ®ï¼Œä¸èƒ½åªæ˜¯é‡å¤æäº¤
- ç”³è¯‰æ–‡æ¡ˆè¦ç«™åœ¨å®¡æ ¸äººå‘˜è§’åº¦å†™ï¼Œè®©ä»–ä¸€çœ¼çœ‹åˆ°å…³é”®ä¿¡æ¯
- æœ€ä½³æäº¤æ—¶é—´ï¼šå·¥ä½œæ—¥ä¸Šåˆ9-11ç‚¹ï¼Œé¿å¼€å‘¨æœ«å’ŒèŠ‚å‡æ—¥

### ç»“ç®—è´¦æˆ·ç›¸å…³
- èµ„é‡‘å†»ç»“æ¡ˆä»¶å¿…é¡»æä¾›ç»“ç®—è´¦æˆ·å¼€æˆ·é“¶è¡Œå’Œè´¦æˆ·åå››ä½
- æ‹¨æ‰“95017è½¬3å‚¬å®¡æ—¶éœ€è¦æä¾›å•†æˆ·å·+ç»“ç®—è´¦æˆ·åå››ä½éªŒè¯èº«ä»½
- ç”³è¯‰æˆåŠŸåèµ„é‡‘3-5ä¸ªå·¥ä½œæ—¥è‡ªåŠ¨è§£å†»åˆ°ç»“ç®—è´¦æˆ·
- æœªç”³è¯‰çš„å†»ç»“æœŸä¸€èˆ¬ä¸º180å¤©

## ä¿¡æ¯æ”¶é›†æµç¨‹
ç³»ç»Ÿå·²é€šè¿‡æœ¬åœ°å¼•æ“é€æ­¥æ”¶é›†ç”¨æˆ·ä¿¡æ¯ã€‚å½“ç”¨æˆ·åœ¨èŠå¤©ä¸­æé—®æ—¶ï¼Œè¯·ç»“åˆå·²æ”¶é›†çš„æ•°æ®ç»™å‡ºä¸“ä¸šå»ºè®®ã€‚ä½ è¦åƒçœŸæ­£çš„é¡¾é—®ä¸€æ ·æ€è€ƒå’Œæ¨ç†ï¼Œè€Œä¸æ˜¯ç®€å•çš„é—®ç­”æœºå™¨ã€‚

## ç”ŸæˆæŠ¥å‘Šæ ¼å¼
å½“æ”¶åˆ°buildReportPromptçš„æŒ‡ä»¤æ—¶ï¼Œè¾“å‡ºå®Œæ•´æŠ¥å‘Šï¼Œæ¯éƒ¨åˆ†â‰¤300å­—ï¼Œè¯­è¨€æ­£å¼ä¸¥è°¨ï¼Œå¯ç›´æ¥å¤åˆ¶ç”¨äºå¾®ä¿¡ç”³è¯‰æäº¤ã€‚æŠ¥å‘ŠåŒ…å«ï¼šæ¡ˆæƒ…è¯„ä¼°ã€æŠ•è¯‰å¤„ç†æ–¹æ³•ã€é€€æ¬¾è§„åˆ™ã€æŠ•è¯‰åŸå› è¯¦æƒ…ã€ä¸šåŠ¡æ¨¡å¼ã€æ•´æ”¹è¯´æ˜ï¼Œä»¥åŠè¯¦ç»†çš„ç”³è¯‰æäº¤æŒ‡å—ã€‚

## æŠ¥ä»·å‚è€ƒï¼ˆåœ¨æ¡ˆæƒ…è¯„ä¼°ä¸­è‡ªç„¶æåŠï¼‰
| æ¡ˆä»¶ç±»å‹ | éš¾åº¦ | å‚è€ƒä»·æ ¼ |
|---------|------|--------|
| äº¤æ˜“æ‹¦æˆªï¼ˆé¦–æ¬¡ï¼‰ | ä½ | 500-800å…ƒ |
| äº¤æ˜“é™é¢ï¼ˆæœ‰æŠ•è¯‰ï¼‰ | ä¸­ä½ | 800-1500å…ƒ |
| å…³é—­æ”¯ä»˜æƒé™ | ä¸­ | 1500-2500å…ƒ |
| å…³é—­æ”¯ä»˜+è¢«é©³å›è¿‡ | é«˜ | 2500-4000å…ƒ |
| èµ„é‡‘å†»ç»“/å¤æ‚æ¡ˆä»¶ | æé«˜ | 4000-6000å…ƒ |

## å¯¹è¯é£æ ¼
- ä¸“ä¸šã€ç®€æ´ã€è‡ªä¿¡ã€äº²å’Œï¼Œä½“ç°ä¸°å¯Œçš„ç”³è¯‰ç»éªŒ
- æ¯æ¬¡å›å¤æ§åˆ¶åœ¨åˆç†é•¿åº¦ï¼Œä¸è¦é•¿ç¯‡å¤§è®º
- æ¯æ¬¡åªé—®ä¸€ä¸ªé—®é¢˜ï¼Œç­‰å®¢æˆ·å›ç­”
- ç»å¯¹ä¸è¦ä½¿ç”¨ Markdown æ ¼å¼ï¼ˆä¸è¦ç”¨ **ç²—ä½“**ã€### æ ‡é¢˜ã€- åˆ—è¡¨ç­‰ï¼‰
- ä½¿ç”¨çº¯æ–‡æœ¬æ ¼å¼ï¼Œæ–¹ä¾¿ç”¨æˆ·ç›´æ¥å¤åˆ¶ç²˜è´´åˆ°å¾®ä¿¡
- é€‰é¡¹åˆ—è¡¨ç”¨ â‘  â‘¡ â‘¢ â‘£ â‘¤ ç¼–å·ï¼Œä¸è¦ç”¨ - æˆ– * æˆ– â€¢ ç¬¦å·
- å¯ä»¥ä½¿ç”¨ âœ… ğŸ’¡ âš ï¸ ğŸ”‘ ğŸ“Š ç­‰å°‘é‡å®ç”¨emojiå¢å¼ºå¯è¯»æ€§
- å¥å°¾å¯ä»¥é€‚å½“ç”¨ ~ è®©è¯­æ°”æ›´äº²å’Œ
- å›ç­”ç”¨æˆ·é—®é¢˜æ—¶ï¼Œå¼•ç”¨ç”¨æˆ·å·²æä¾›çš„å…·ä½“æ•°æ®ï¼Œè®©ç”¨æˆ·æ„Ÿå—åˆ°ä¸ªæ€§åŒ–æœåŠ¡
- ä¸»åŠ¨å¼•ç”¨ç±»ä¼¼è¡Œä¸šçš„æˆåŠŸæ¡ˆä¾‹å¢å¼ºç”¨æˆ·ä¿¡å¿ƒ
- å¯¹èµ„é‡‘å†»ç»“æ¡ˆä»¶ä¸»åŠ¨æé†’ç»“ç®—è´¦æˆ·ç›¸å…³ä¿¡æ¯çš„é‡è¦æ€§
- æ”¶åˆ°å…³é”®ä¿¡æ¯åç»™å‡ºå³æ—¶è¯Šæ–­ï¼ˆå¦‚ï¼šäº†è§£åˆ°æ˜¯"æ¶‰å«Œäº¤æ˜“å¼‚å¸¸"ï¼Œé©¬ä¸Šå‘Šè¯‰ç”¨æˆ·è¿™ç±»æ¡ˆä»¶æˆåŠŸç‡è¾ƒé«˜ï¼Œå…³é”®æ˜¯ä»€ä¹ˆï¼‰`

/**
 * æ„å»ºåŒ…å«ç”¨æˆ·å·²æ”¶é›†æ•°æ®çš„å®Œæ•´ system prompt
 * è®© DeepSeek åœ¨å›ç­”é—®é¢˜æ—¶èƒ½å‚è€ƒç”¨æˆ·æ•°æ®ï¼Œç»™å‡ºä¸ªæ€§åŒ–å›ç­”
 */
function buildSystemPrompt(collectedData = {}) {
  const keys = Object.keys(collectedData)
  if (keys.length === 0) return BASE_SYSTEM_PROMPT

  const fieldLabels = {
    problem_type: 'å¤„ç½šç±»å‹', violation_reason: 'è¿è§„åŸå› ',
    merchant_id: 'å•†æˆ·å·', merchant_name: 'å•†æˆ·åç§°',
    company_name: 'å…¬å¸å…¨ç§°', license_no: 'ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ',
    legal_name: 'æ³•äººå§“å', legal_id_last4: 'èº«ä»½è¯åå››ä½',
    industry: 'æ‰€å±è¡Œä¸š', business_model: 'ç»è¥æ¨¡å¼',
    complaint_status: 'æŠ•è¯‰æƒ…å†µ', refund_policy: 'é€€æ¬¾æ”¿ç­–',
    bank_name: 'å¼€æˆ·é“¶è¡Œ', bank_account_last4: 'ç»“ç®—è´¦æˆ·åå››ä½',
    contact_phone: 'è”ç³»ç”µè¯', appeal_history: 'ç”³è¯‰å†å²',
  }

  let dataSection = '\n\n## å½“å‰ç”¨æˆ·å·²æä¾›çš„æ•°æ®ï¼ˆå›ç­”é—®é¢˜æ—¶å¿…é¡»å‚è€ƒä»¥ä¸‹ä¿¡æ¯ï¼‰\n\n'
  dataSection += '\n> ä»¥ä¸‹æ˜¯ç”¨æˆ·å·²ç»æä¾›çš„ä¿¡æ¯ï¼Œå›ç­”ä»»ä½•é—®é¢˜æ—¶è¯·ç»“åˆè¿™äº›å…·ä½“æ•°æ®ç»™å‡ºé’ˆå¯¹æ€§å»ºè®®ã€‚ä¸è¦å¿½ç•¥ç”¨æˆ·æ•°æ®ç»™å‡ºæ³›æ³›çš„é€šç”¨å›ç­”ã€‚\n\n'
  for (const [key, value] of Object.entries(collectedData)) {
    if (key.startsWith('_')) continue  // è·³è¿‡å†…éƒ¨å­—æ®µ
    if (value && value.trim()) {
      const label = fieldLabels[key] || key
      dataSection += `- **${label}**ï¼š${value}\n`
    }
  }
  // å½“å‰æ”¶é›†è¿›åº¦ä¸Šä¸‹æ–‡ï¼ˆè®© AI çŸ¥é“æ­£åœ¨é—®ä»€ä¹ˆï¼‰
  if (collectedData._current_step) {
    dataSection += `\n\n## å½“å‰æ”¶é›†è¿›åº¦\n`
    dataSection += `è¿›åº¦ï¼š${collectedData._current_step}\n`
    dataSection += `å½“å‰æ­£åœ¨æ”¶é›†ï¼š${collectedData._current_field_label || ''}\n`
    dataSection += `å½“å‰é—®é¢˜ï¼š${collectedData._current_question || ''}\n`
    // å¯Œä¸Šä¸‹æ–‡ï¼ˆåŒ…å«å®Œæ•´æ”¶é›†è¿›åº¦ã€é£é™©è¯„ä¼°ã€è¡Œä¸šåˆ†æã€å¯¹è¯æŒ‡å¯¼ï¼‰
    if (collectedData._collection_context) dataSection += collectedData._collection_context
    if (collectedData._instruction) dataSection += `\nâš ï¸ ${collectedData._instruction}\n`
  }

  // æ•æ„Ÿè¡Œä¸šç‰¹åˆ«æç¤º
  if (collectedData._sensitive_industry) {
    dataSection += `\nâš ï¸ **é‡è¦ï¼šè¯¥ç”¨æˆ·è¡Œä¸šè¢«æ£€æµ‹ä¸ºæ•æ„Ÿç±»ç›®ã€Œ${collectedData._sensitive_industry}ã€ï¼Œé£é™©ç­‰çº§ï¼š${collectedData._sensitive_risk || 'æœªçŸ¥'}ã€‚**\n`
    dataSection += 'å›ç­”æ—¶éœ€ç‰¹åˆ«æ³¨æ„ï¼š1) å¦‚å®è¯„ä¼°ç”³è¯‰éš¾åº¦ï¼Œä¸è¦è¿‡åº¦ä¹è§‚ 2) é‡ç‚¹å¼ºè°ƒéœ€è¦çš„åˆè§„èµ„è´¨å’Œè¯æ˜ææ–™ 3) å¦‚æœä¸šåŠ¡ç¡®å®è¿è§„ï¼Œå»ºè®®ç”¨æˆ·è€ƒè™‘æ•´æ”¹åå†ç”³è¯‰æˆ–æ›´æ¢åˆè§„ä¸šåŠ¡æ¨¡å¼\n'
  }

  dataSection += '\nè¯·åœ¨é€‚å½“æ—¶å€™æé†’ç”¨æˆ·ï¼šæ‚¨æä¾›çš„æ•°æ®ä»…åœ¨æœ¬æ¬¡èŠå¤©å’¨è¯¢ä¸­ä½¿ç”¨ï¼Œä¸ä¼šç”¨äºå…¶ä»–ä»»ä½•ç”¨é€”ã€‚'

  return BASE_SYSTEM_PROMPT + dataSection
}

const WELCOME_MESSAGE = `æ‚¨å¥½ï¼æˆ‘æ˜¯å¾®ä¿¡å•†æˆ·å·ç”³è¯‰ä¸“å®¶~

ä¸ºäº†ç»™æ‚¨ç”Ÿæˆä¸“ä¸šçš„ç”³è¯‰ææ–™ï¼Œæˆ‘éœ€è¦å…ˆäº†è§£ä¸€ä¸‹æ‚¨çš„æƒ…å†µï¼ˆå…±16é¡¹ä¿¡æ¯ï¼‰ã€‚æ”¶é›†å®Œæˆåï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºæ‚¨ç”Ÿæˆå®Œæ•´çš„è¯„ä¼°æŠ¥å‘Šå’Œå¯ç›´æ¥æäº¤çš„ç”³è¯‰ææ–™ã€‚

æˆ‘ä»¬å…ˆä»æœ€åŸºæœ¬çš„å¼€å§‹ï¼š

ğŸ’¼ è¯·å…ˆä»‹ç»ä¸€ä¸‹æ‚¨çš„ä¸šåŠ¡ï¼šæ‚¨çš„å°ç¨‹åº/å•†æˆ·å·æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ

æ¯”å¦‚ï¼šé¤é¥®å¤–å–ã€æœè£…é›¶å”®ã€æ•™è‚²åŸ¹è®­ã€ä¼ä¸šå¹´æŠ¥å·¥å…·ã€SaaSè½¯ä»¶ã€ç”Ÿæ´»æœåŠ¡ã€æ¸¸æˆã€é™ªç©ã€ç›²ç›’æ½®ç©ã€çŸ¥è¯†ä»˜è´¹ã€å® ç‰©ã€æ±½è½¦ã€ç å®ã€å¹¿å‘Šè¥é”€â€¦â€¦

è¯·ç”¨æ‚¨è‡ªå·±çš„è¯æè¿°å°±å¥½ï¼Œä¸ç”¨å¤ªæ­£å¼~

ğŸ’¡ æ‚¨å¡«å†™çš„ä¿¡æ¯ä¼šå®æ—¶æ˜¾ç¤ºåœ¨å³ä¾§é¢æ¿ä¸­ï¼Œæ–¹ä¾¿éšæ—¶æŸ¥çœ‹å’Œæ ¸å¯¹ã€‚
ğŸ’¡ ä»»ä½•é—®é¢˜éƒ½å¯ä»¥éšæ—¶é—®æˆ‘ï¼Œæ¯”å¦‚"ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªä¿¡æ¯"ã€‚
ğŸ”’ éšç§ä¿æŠ¤ï¼šæ‰€æœ‰æ•°æ®ä»…ç”¨äºæœ¬æ¬¡å’¨è¯¢ã€‚`

export function getWelcomeMessage() {
  return WELCOME_MESSAGE
}

// DeepSeek API è°ƒç”¨ï¼ˆæ”¯æŒè‡ªå®šä¹‰ API Key + ç”¨æˆ·æ•°æ®ä¸Šä¸‹æ–‡ï¼‰
async function callDeepSeek(chatHistory, customApiKey, collectedData = {}) {
  // ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„è‡ªå®šä¹‰ keyï¼Œå¦åˆ™ä½¿ç”¨ç³»ç»Ÿé…ç½®çš„å®˜æ–¹ key
  const apiKey = customApiKey || await getSystemConfig('deepseek_api_key')
  if (!apiKey) return null

  const model = (await getSystemConfig('deepseek_model')) || 'deepseek-chat'
  const temp = parseFloat((await getSystemConfig('ai_temperature')) || '0.7')

  // DeepSeek API åªæ¥å— system/user/assistant ä¸‰ç§ role
  // admin â†’ assistantï¼ˆç®¡ç†å‘˜å›å¤å¯¹ AI æ¥è¯´ç­‰åŒåŠ©æ‰‹æ¶ˆæ¯ï¼‰
  const systemPrompt = buildSystemPrompt(collectedData)
  const messages = [
    { role: 'system', content: systemPrompt },
    ...chatHistory.map(m => ({
      role: m.role === 'admin' ? 'assistant' : (m.role === 'user' ? 'user' : 'assistant'),
      content: m.content,
    })),
  ]

  // å¸¦è¶…æ—¶å’Œé‡è¯•çš„è¯·æ±‚
  const MAX_RETRIES = 2
  let lastErr = null
  let res = null

  for (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {
    try {
      const controller = new AbortController()
      const timeout = setTimeout(() => controller.abort(), 30000) // 30ç§’è¶…æ—¶
      res = await fetch('https://api.deepseek.com/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`,
        },
        body: JSON.stringify({ model, messages, temperature: temp, max_tokens: 4096 }),
        signal: controller.signal,
      })
      clearTimeout(timeout)
      break // æˆåŠŸè¿æ¥
    } catch (err) {
      lastErr = err
      console.error(`DeepSeek fetch attempt ${attempt + 1} failed:`, err.message)
      if (attempt < MAX_RETRIES) {
        await new Promise(r => setTimeout(r, 1000 * (attempt + 1))) // é€’å¢ç­‰å¾…
      }
    }
  }

  if (!res) {
    console.error('DeepSeek: all retries failed')
    throw new Error('NETWORK_ERROR')
  }

  if (!res.ok) {
    const errText = await res.text()
    console.error('DeepSeek API error:', res.status, errText)
    const errCode = res.status
    if (errCode === 401) throw new Error('API_KEY_INVALID')
    if (errCode === 402) throw new Error('API_BALANCE_INSUFFICIENT')
    if (errCode === 429) throw new Error('API_RATE_LIMIT')
    throw new Error(`API_ERROR_${errCode}`)
  }

  const data = await res.json()
  const content = data.choices?.[0]?.message?.content || null
  if (!content) return null

  // ä¼˜å…ˆä½¿ç”¨ API è¿”å›çš„ token ç”¨é‡ï¼Œå¦åˆ™æœ¬åœ°è®¡ç®—
  let inputTokens, outputTokens
  if (data.usage) {
    inputTokens = data.usage.prompt_tokens || 0
    outputTokens = data.usage.completion_tokens || 0
  } else {
    inputTokens = countMessagesTokens(messages)
    outputTokens = countTokens(content)
  }

  return { content, inputTokens, outputTokens }
}

// ========== è§„åˆ™å¼•æ“ï¼ˆDeepSeek ä¸å¯ç”¨æ—¶çš„åå¤‡æ–¹æ¡ˆï¼‰ ==========

const STEPS = {
  WELCOME: 0,
  ASK_PROBLEM: 1,       // ç¬¬1æ­¥ï¼šé—®å¤„ç½šç±»å‹
  ASK_BUSINESS: 2,      // ç¬¬2æ­¥ï¼šé—®è¡Œä¸šå’Œç»è¥æ¨¡å¼
  ASK_VIOLATION: 3,     // ç¬¬3æ­¥ï¼šé—®è¿è§„åŸå› 
  ASK_COMPLAINT: 4,     // ç¬¬4æ­¥ï¼šé—®æŠ•è¯‰æƒ…å†µ
  ASK_REFUND: 5,        // ç¬¬5æ­¥ï¼šé—®é€€æ¬¾å”®åæµç¨‹
  ASK_APPEAL: 6,        // ç¬¬6æ­¥ï¼šé—®ç”³è¯‰å†å²
  GENERATE: 7,          // ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š + ç”³è¯‰ææ–™
  DONE: 8,
}

// æ ¹æ®æƒ…å†µè¯„ä¼°éš¾åº¦å’ŒæŠ¥ä»·
function assessCase(d) {
  const problem = (d.problem || '').toLowerCase()
  const violation = (d.violation || '').toLowerCase()
  const appealHist = (d.appealHistory || '').toLowerCase()
  const hasAppealed = appealHist.includes('ç”³è¯‰è¿‡') || appealHist.includes('é©³å›') || appealHist.includes('ç»´æŒ') || (appealHist.length > 2 && !appealHist.includes('æ²¡') && !appealHist.includes('æ— ') && !appealHist.includes('ç¬¬ä¸€æ¬¡') && !appealHist.includes('æ²¡æœ‰'))

  let difficulty, level, price, successRate

  if (problem.includes('å†»ç»“') || problem.includes('å°ç¦')) {
    difficulty = 'â­â­â­â­â­ éå¸¸å›°éš¾'
    level = hasAppealed ? 'æéš¾' : 'å›°éš¾'
    price = hasAppealed ? 'Â¥4500-6000' : 'Â¥3500-5000'
    successRate = hasAppealed ? '50-65%' : '65-80%'
  } else if (problem.includes('å…³é—­') || problem.includes('é™åˆ¶æ”¶æ¬¾') || problem.includes('æ— æ³•æ”¶æ¬¾')) {
    difficulty = hasAppealed ? 'â­â­â­â­ å›°éš¾' : 'â­â­â­ è¾ƒéš¾'
    level = hasAppealed ? 'å›°éš¾' : 'è¾ƒéš¾'
    price = hasAppealed ? 'Â¥2500-4000' : 'Â¥1500-2500'
    successRate = hasAppealed ? '60-75%' : '75-90%'
  } else if (problem.includes('é™é¢') || problem.includes('é™åˆ¶')) {
    difficulty = 'â­â­ ä¸­ç­‰'
    level = 'ä¸­ç­‰'
    price = 'Â¥800-1500'
    successRate = '80-92%'
  } else {
    difficulty = 'â­ ç®€å•'
    level = 'ç®€å•'
    price = 'Â¥500-800'
    successRate = '90-95%'
  }

  return { difficulty, level, price, successRate, hasAppealed }
}

function fallbackProcess(userMessage, step, data) {
  const d = { ...data }
  let text = '', next = step

  switch (step) {
    case STEPS.WELCOME: case STEPS.ASK_PROBLEM: {
      d.problem = userMessage
      next = STEPS.ASK_BUSINESS
      const msg = userMessage.toLowerCase()
      let fb = 'æ”¶åˆ°ï¼Œæˆ‘å…ˆäº†è§£æ¸…æ¥šæ‚¨çš„æƒ…å†µã€‚'
      if (msg.includes('å†»ç»“')) fb = 'èµ„é‡‘å†»ç»“æ˜¯æ¯”è¾ƒä¸¥é‡çš„å¤„ç½šï¼Œä½†ä¸ç”¨æ‹…å¿ƒï¼Œè¿™ç±»æ¡ˆä»¶æˆ‘ä»¬å¤„ç†è¿‡å¾ˆå¤šã€‚'
      else if (msg.includes('å…³é—­') || msg.includes('æ— æ³•æ”¶æ¬¾')) fb = 'æ”¯ä»˜æƒé™è¢«å…³é—­å½±å“è¾ƒå¤§ï¼Œä½†é€šè¿‡ä¸“ä¸šç”³è¯‰æ¢å¤æˆåŠŸç‡å¾ˆé«˜ã€‚'
      else if (msg.includes('é™é¢') || msg.includes('é™åˆ¶')) fb = 'æ”¶æ¬¾é™é¢æ˜¯å¸¸è§çš„å¤„ç½šï¼Œé€šå¸¸æ˜¯é£æ§ç³»ç»Ÿè‡ªåŠ¨è§¦å‘ï¼Œç”³è¯‰ç›¸å¯¹å¥½å¤„ç†ã€‚'
      else if (msg.includes('æ‹¦æˆª')) fb = 'äº¤æ˜“æ‹¦æˆªé€šå¸¸æ˜¯é˜¶æ®µæ€§é£æ§æªæ–½ï¼ŒåŠæ—¶ç”³è¯‰ä¸€èˆ¬éƒ½èƒ½è§£å†³ã€‚'
      text = `${fb}\n\nç¬¬äºŒä¸ªé—®é¢˜ï¼š**æ‚¨çš„å•†æˆ·å·ä¸»è¦ç»è¥ä»€ä¹ˆä¸šåŠ¡ï¼Ÿ**\n\nè¯·ç®€å•è¯´æ˜è¡Œä¸šã€äº§å“/æœåŠ¡ã€çº¿ä¸Šè¿˜æ˜¯çº¿ä¸‹ç»è¥ã€‚`
      break
    }

    case STEPS.ASK_BUSINESS:
      d.business = userMessage
      next = STEPS.ASK_VIOLATION
      text = `å¥½çš„ï¼Œäº†è§£äº†æ‚¨çš„ç»è¥æƒ…å†µã€‚\n\nç¬¬ä¸‰ä¸ªé—®é¢˜ï¼š**å¾®ä¿¡ç»™å‡ºçš„å…·ä½“è¿è§„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ**\n\nè¯·æ‰“å¼€ã€Œå¾®ä¿¡æ”¯ä»˜å•†å®¶åŠ©æ‰‹ã€å°ç¨‹åº â†’ æˆ‘æ˜¯å•†å®¶ â†’ é£é™©å¤„ç† â†’ åŠŸèƒ½é™åˆ¶è®°å½• æŸ¥çœ‹ã€‚`
      break

    case STEPS.ASK_VIOLATION:
      d.violation = userMessage
      next = STEPS.ASK_COMPLAINT
      text = `æ˜ç™½äº†ï¼Œè¿™ä¸ªä¿¡æ¯å¾ˆå…³é”®ã€‚\n\nç¬¬å››ä¸ªé—®é¢˜ï¼š**ç›®å‰æœ‰æ²¡æœ‰æœªå¤„ç†çš„æ¶ˆè´¹è€…æŠ•è¯‰ï¼ŸæŠ•è¯‰åŸå› ä¸»è¦æ˜¯ä»€ä¹ˆï¼Ÿ**\n\nå¯ä»¥åœ¨å•†æˆ·å¹³å° â†’ è´¦æˆ·ä¸­å¿ƒ â†’ æ¶ˆè´¹è€…æŠ•è¯‰ ä¸­æŸ¥çœ‹ã€‚`
      break

    case STEPS.ASK_COMPLAINT:
      d.complaint = userMessage
      next = STEPS.ASK_REFUND
      text = `æ”¶åˆ°ã€‚\n\nç¬¬äº”ä¸ªé—®é¢˜ï¼š**æ‚¨ç›®å‰çš„é€€æ¬¾å”®åæµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ**\n\nè¯·è¯´æ˜é€€æ¬¾æ—¶é™ã€é€€æ¬¾æ¡ä»¶ã€å¤„ç†æ–¹å¼ç­‰ã€‚å¦‚æœæš‚æ—¶æ²¡æœ‰å®Œå–„çš„é€€æ¬¾æ”¿ç­–ï¼Œå‘Šè¯‰æˆ‘å³å¯ï¼Œæˆ‘ä¼šå¸®æ‚¨æ‹Ÿå®šã€‚`
      break

    case STEPS.ASK_REFUND:
      d.refund = userMessage
      next = STEPS.ASK_APPEAL
      text = `å¥½çš„ã€‚\n\næœ€åä¸€ä¸ªé—®é¢˜ï¼š**ä¹‹å‰æœ‰æ²¡æœ‰å°±è¿™ä¸ªé—®é¢˜ç”³è¯‰è¿‡ï¼Ÿç»“æœå¦‚ä½•ï¼Ÿ**`
      break

    case STEPS.ASK_APPEAL:
      d.appealHistory = userMessage
      next = STEPS.GENERATE
      d._assess = assessCase(d)
      text = buildAppealMaterials(d)
      break

    case STEPS.GENERATE: case STEPS.DONE: {
      next = STEPS.DONE
      const isFrozen = (d.problem || '').includes('å†»ç»“') || (d.problem || '').includes('å»¶è¿Ÿ')
      text = `ä»¥ä¸Šå°±æ˜¯å®Œæ•´çš„è¯„ä¼°æŠ¥å‘Šå’Œç”³è¯‰ææ–™ âœ…\n\n**ğŸ“Œ ç”³è¯‰æäº¤æŒ‡å—ï¼š**\n\n**æäº¤æ–¹å¼ï¼š** å¾®ä¿¡æ”¯ä»˜å•†å®¶åŠ©æ‰‹å°ç¨‹åº â†’ é£é™©å¤„ç† â†’ ç”³è¯‰ä¸­å¿ƒ â†’ å‘èµ·ç”³è¯‰\n\n**é‡è¦æé†’ï¼š**\n1. ğŸ“¸ è¯ä»¶ç…§ç‰‡ä¸€å®šè¦æ¸…æ™°å®Œæ•´ï¼Œæ¨¡ç³Š/ç¼ºè§’ä¼šè¢«ç›´æ¥é©³å›\n2. ğŸ“‹ è®¢å•å·å¡«**å¾®ä¿¡æ”¯ä»˜è®¢å•å·**ï¼ˆ4å¼€å¤´28ä½ï¼‰ï¼Œä¸æ˜¯åº—é“ºè®¢å•å·\n3. â° è¡¥å……èµ„æ–™é€šé“é€šå¸¸åªå¼€æ”¾**24å°æ—¶**ï¼ŒåŠ¡å¿…åœ¨æ—¶é™å†…æäº¤\n4. ğŸ“ å®¡æ ¸**3-7ä¸ªå·¥ä½œæ—¥**ï¼ŒæœŸé—´ä¿æŒç”µè¯ç•…é€šï¼ˆå¯èƒ½æœ‰å›è®¿ï¼‰\n5. âŒ å¦‚è¢«é©³å›ï¼šå…ˆæ‰“**95017è½¬3**æŸ¥è¯¢å…·ä½“åŸå› ï¼Œé—´éš”3-5å¤©åé’ˆå¯¹æ€§è¡¥å……\n6. âš ï¸ è¿ç»­5æ¬¡ç”³è¯‰ä¸é€šè¿‡å¯èƒ½è¢«æ ‡è®°ä¸º"ä¸æ”¯æŒç”³è¯‰"ï¼Œæ¯æ¬¡åŠ¡å¿…å……åˆ†å‡†å¤‡${isFrozen ? '\n7. ğŸ¦ èµ„é‡‘å†»ç»“æ¡ˆä»¶ï¼šæ‹¨æ‰“95017è½¬3æ—¶æä¾›**å•†æˆ·å·+ç»“ç®—è´¦æˆ·åå››ä½**å¯å‚¬ä¿ƒè§£å†»è¿›åº¦' : ''}\n\nå¦‚éœ€ä¿®æ”¹ææ–™æˆ–æœ‰ä»»ä½•ç–‘é—®ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼`
      break
    }
  }
  return { response: text, nextStep: next, collectedData: d }
}

function buildAppealMaterials(d) {
  const assess = d._assess || assessCase(d)
  const hasBusiness = d.business && d.business.trim().length > 5
  const hasRefund = d.refund && d.refund.trim().length > 3
  const hasAppealHistory = d.appealHistory && !d.appealHistory.includes('æ²¡') && !d.appealHistory.includes('æ— ') && !d.appealHistory.includes('ç¬¬ä¸€æ¬¡')

  // ç”Ÿæˆè¿è§„ç±»å‹ç›¸å…³å†…å®¹
  const v = (d.violation || d.problem || '').toLowerCase()
  let violationAnalysis, complaintMethod

  if (v.includes('äº¤æ˜“å¼‚å¸¸') || v.includes('åˆ·å•')) {
    violationAnalysis = `ç»æˆ‘æ–¹è¯¦ç»†æ’æŸ¥ï¼Œè¿‘æœŸäº¤æ˜“é‡å˜åŒ–ç³»å› æ­£å¸¸è¥é”€æ¨å¹¿æ´»åŠ¨åŠå­£èŠ‚æ€§éœ€æ±‚æ³¢åŠ¨æ‰€è‡´ï¼Œå±äºæ­£å¸¸ç»è¥è¡Œä¸ºã€‚æˆ‘æ–¹æ‰€æœ‰äº¤æ˜“å‡ä¸ºçœŸå®å®¢æˆ·çš„çœŸå®è´­ä¹°è¡Œä¸ºï¼Œæ¯ç¬”è®¢å•å‡æœ‰å¯¹åº”çš„å•†å“å‘è´§è®°å½•ã€ç‰©æµä¿¡æ¯åŠå®¢æˆ·ç­¾æ”¶ç¡®è®¤ï¼Œä¸å­˜åœ¨ä»»ä½•åˆ·å•æˆ–è™šå‡äº¤æ˜“è¡Œä¸ºã€‚æˆ‘æ–¹å¯æä¾›ä»»æ„è®¢å•çš„å®Œæ•´äº¤æ˜“é“¾è·¯è¯æ®ï¼ŒåŒ…æ‹¬å®¢æˆ·å’¨è¯¢è®°å½•ã€ä¸‹å•æˆªå›¾ã€å‘è´§å‡­è¯åŠç­¾æ”¶ç¡®è®¤ã€‚`
    complaintMethod = `æˆ‘æ–¹å·²å¯¹æ‰€æœ‰æ¶ˆè´¹è€…åé¦ˆè¿›è¡Œå…¨é¢æ’æŸ¥ï¼Œé€ä¸€è”ç³»ç›¸å…³å®¢æˆ·è¿›è¡Œæ²Ÿé€šè¯´æ˜ã€‚å¯¹äºå› ç‰©æµå»¶è¿Ÿæˆ–ä¿¡æ¯è¯¯è§£äº§ç”Ÿçš„æŠ•è¯‰ï¼Œå·²ä¸»åŠ¨æä¾›è¡¥å¿æ–¹æ¡ˆå¹¶å–å¾—å®¢æˆ·è°…è§£ã€‚ç›®å‰æ‰€æœ‰æŠ•è¯‰å‡å·²å¦¥å–„å¤„ç†å®Œæ¯•ï¼ŒæŠ•è¯‰ç‡å·²æ¢å¤è‡³æ­£å¸¸æ°´å¹³ã€‚`
  } else if (v.includes('çº çº·') || v.includes('æŠ•è¯‰')) {
    violationAnalysis = `ç»æˆ‘æ–¹æ’æŸ¥ï¼Œæœ¬æ¬¡å¤„ç½šç³»å› éƒ¨åˆ†æ¶ˆè´¹è€…æŠ•è¯‰æœªèƒ½åŠæ—¶å¤„ç†ï¼Œå¯¼è‡´æŠ•è¯‰ç‡çŸ­æš‚è¶…æ ‡ã€‚ä¸»è¦åŸå› ä¸ºï¼šå”®åå®¢æœäººæ‰‹ä¸è¶³å¯¼è‡´å“åº”ä¸åŠæ—¶ï¼Œéƒ¨åˆ†å®¢æˆ·å¯¹äº§å“/æœåŠ¡å­˜åœ¨è¯¯è§£ã€‚æˆ‘æ–¹å·²æ·±åˆ»è®¤è¯†åˆ°å”®åæœåŠ¡çš„é‡è¦æ€§ï¼Œå·²å¯¹æ‰€æœ‰æŠ•è¯‰é€ä¸€å¤„ç†ï¼Œå¹¶å®Œå–„äº†å”®åæœåŠ¡ä½“ç³»ï¼Œç¡®ä¿åç»­æŠ•è¯‰èƒ½åœ¨ç¬¬ä¸€æ—¶é—´å¾—åˆ°å¦¥å–„è§£å†³ã€‚`
    complaintMethod = `${d.complaint ? `å…³äºæ¶ˆè´¹è€…æŠ•è¯‰æƒ…å†µï¼š${d.complaint}\n\n` : ''}æˆ‘æ–¹å·²é‡‡å–ä»¥ä¸‹æªæ–½å¤„ç†å…¨éƒ¨æŠ•è¯‰ï¼š1ï¼‰é€ä¸€è”ç³»æŠ•è¯‰ç”¨æˆ·ï¼Œäº†è§£å…·ä½“è¯‰æ±‚å¹¶åå•†è§£å†³æ–¹æ¡ˆï¼›2ï¼‰å¯¹åˆç†é€€æ¬¾è¯·æ±‚å·²å…¨éƒ¨åŠç†é€€æ¬¾å¤„ç†ï¼›3ï¼‰å¯¹å› è¯¯è§£äº§ç”Ÿçš„æŠ•è¯‰å·²è€å¿ƒæ²Ÿé€šè¯´æ˜ï¼Œå–å¾—å®¢æˆ·ç†è§£ä¸å’Œè§£ï¼›4ï¼‰ç›®å‰å·²æ— æœªå¤„ç†çš„æ¶ˆè´¹è€…æŠ•è¯‰ï¼ŒæŠ•è¯‰å¤„ç†ç‡è¾¾100%ã€‚`
  } else if (v.includes('è·¨ç±»ç›®') || v.includes('ç±»ç›®')) {
    violationAnalysis = `ç»æˆ‘æ–¹è‡ªæŸ¥ï¼Œåœ¨å®é™…ç»è¥è¿‡ç¨‹ä¸­ï¼Œéƒ¨åˆ†å•†å“/æœåŠ¡çš„æè¿°ä¸æ³¨å†Œç±»ç›®å­˜åœ¨åå·®ï¼Œå¯¹æ­¤æˆ‘æ–¹æ·±è¡¨æ­‰æ„ã€‚è¿™å¹¶éä¸»è§‚è¿è§„ï¼Œè€Œæ˜¯å› å¯¹ç±»ç›®ç•Œå®šç†è§£ä¸å¤Ÿå‡†ç¡®æ‰€è‡´ã€‚æˆ‘æ–¹å·²ç«‹å³å¯¹å…¨éƒ¨å•†å“/æœåŠ¡è¿›è¡Œæ¢³ç†è°ƒæ•´ï¼Œç¡®ä¿ç»è¥å†…å®¹ä¸¥æ ¼æ§åˆ¶åœ¨æ³¨å†Œç±»ç›®èŒƒå›´å†…ï¼Œæœç»è·¨ç±»ç›®ç»è¥è¡Œä¸ºã€‚`
    complaintMethod = `æˆ‘æ–¹æ”¶åˆ°å¤„ç½šé€šçŸ¥åï¼Œå·²ç¬¬ä¸€æ—¶é—´ä¸‹æ¶ä¸ç¬¦åˆæ³¨å†Œç±»ç›®çš„å•†å“/æœåŠ¡ï¼Œå¹¶å¯¹å·²è´­ä¹°å®¢æˆ·è¿›è¡Œé€ä¸€æ²Ÿé€šã€‚å¯¹äºå—å½±å“çš„å®¢æˆ·ï¼Œæˆ‘æ–¹ä¸»åŠ¨æä¾›å…¨é¢é€€æ¬¾é€‰é¡¹ï¼Œç¡®ä¿æ¶ˆè´¹è€…æƒç›Šä¸å—æŸå®³ã€‚ç›®å‰å·²å¦¥å–„å¤„ç†æ‰€æœ‰ç›¸å…³è®¢å•ï¼Œæ— å®¢æˆ·æŠ•è¯‰æˆ–çº çº·ã€‚`
  } else {
    violationAnalysis = `ç»æˆ‘æ–¹è¯¦ç»†æ’æŸ¥åˆ†æï¼Œ${d.violation ? `å…³äº"${d.violation}"çš„å¤„ç½šï¼Œ` : ''}æˆ‘æ–¹æ‰€æœ‰ç»è¥è¡Œä¸ºå‡åˆæ³•åˆè§„ï¼Œä¸å­˜åœ¨ä¸»è§‚è¿è§„æ„å›¾ã€‚æ­¤æ¬¡å¤„ç½šå¯èƒ½æ˜¯ç”±äºé£æ§ç³»ç»Ÿå¯¹äº¤æ˜“æ¨¡å¼çš„è¯¯åˆ¤æˆ–ä¿¡æ¯é‡‡é›†ä¸å®Œæ•´æ‰€è‡´ã€‚æˆ‘æ–¹å¯æä¾›å®Œæ•´çš„ç»è¥èµ„è´¨ã€äº¤æ˜“å‡­è¯åŠä¸šåŠ¡è¯æ˜ææ–™ï¼Œä»¥è¯æ˜ä¸šåŠ¡çš„çœŸå®æ€§å’Œåˆè§„æ€§ï¼Œæ³è¯·è´µæ–¹é‡æ–°æ ¸å®ã€‚`
    complaintMethod = `${d.complaint ? `å…³äºæŠ•è¯‰æƒ…å†µï¼š${d.complaint}\n\n` : ''}æˆ‘æ–¹ä¸€è´¯é‡è§†æ¶ˆè´¹è€…æƒç›Šä¿æŠ¤ï¼Œå·²å»ºç«‹å®Œå–„çš„å®¢æˆ·æœåŠ¡ä½“ç³»ã€‚å¯¹äºæ‰€æœ‰æ¶ˆè´¹è€…åé¦ˆå’ŒæŠ•è¯‰ï¼Œæˆ‘æ–¹å‡åœ¨ç¬¬ä¸€æ—¶é—´å“åº”å¹¶å¦¥å–„å¤„ç†ã€‚ç›®å‰æ— å¾…å¤„ç†çš„æ¶ˆè´¹è€…æŠ•è¯‰ï¼Œå®¢æˆ·æ»¡æ„åº¦è‰¯å¥½ã€‚`
  }

  return `**ä¿¡æ¯æ”¶é›†å®Œæ¯•ï¼Œæ­£åœ¨ç”Ÿæˆè¯„ä¼°æŠ¥å‘Šå’Œç”³è¯‰ææ–™...**

---

### ğŸ“‹ æ¡ˆæƒ…è¯„ä¼°

- **å¤„ç½šç±»å‹**ï¼š${d.problem || 'å•†æˆ·è¿è§„å¤„ç½š'}
- **è¿è§„åŸå› **ï¼š${d.violation || 'å¾…ç¡®è®¤'}
- **æ¡ˆä»¶éš¾åº¦**ï¼š${assess.difficulty}
- **é¢„ä¼°æˆåŠŸç‡**ï¼š${assess.successRate}
${hasAppealHistory ? `- **ç”³è¯‰å†å²**ï¼š${d.appealHistory}` : '- **ç”³è¯‰å†å²**ï¼šé¦–æ¬¡ç”³è¯‰ï¼ˆæœ‰åˆ©å› ç´ ï¼‰'}

${assess.hasAppealed ? '> âš ï¸ ç”±äºæœ‰è¿‡ç”³è¯‰è¢«é©³å›è®°å½•ï¼Œå†æ¬¡ç”³è¯‰éœ€è¦æ›´å……åˆ†çš„ææ–™å’Œæ›´ç²¾å‡†çš„ç­–ç•¥ã€‚' : 'é¦–æ¬¡ç”³è¯‰é€šå¸¸å…·æœ‰è¾ƒå¥½çš„æ²Ÿé€šå’Œå¤„ç†ç©ºé—´ã€‚'}

**å‚è€ƒæœåŠ¡ä»·æ ¼**ï¼š${assess.price}ï¼ˆå«å…¨å¥—ç”³è¯‰ææ–™æ’°å†™ + ç­–ç•¥æŒ‡å¯¼ï¼‰

---

ä»¥ä¸‹ä¸ºå¯ç›´æ¥å¤åˆ¶æäº¤çš„ç”³è¯‰ææ–™ï¼Œæ¯éƒ¨åˆ†ç‹¬ç«‹ä½¿ç”¨ï¼š

---

### ğŸ“„ ä¸€ã€æŠ•è¯‰å¤„ç†æ–¹æ³•

${complaintMethod}

---

### ğŸ“„ äºŒã€é€€æ¬¾è§„åˆ™

${hasRefund ? `åŸºäºæˆ‘æ–¹ç°è¡Œå”®åæ”¿ç­–ï¼ˆ${d.refund}ï¼‰ï¼Œæ•´ç†ä¸ºä»¥ä¸‹æ­£å¼é€€æ¬¾è§„åˆ™ï¼š\n\n` : ''}æˆ‘æ–¹å·²å»ºç«‹å®Œå–„çš„é€€æ¬¾å”®ååˆ¶åº¦ï¼Œå…·ä½“è§„åˆ™å¦‚ä¸‹ï¼š

1. **é€€æ¬¾é€‚ç”¨æ¡ä»¶**ï¼šæ¶ˆè´¹è€…åœ¨æ”¶åˆ°å•†å“/æœåŠ¡å7æ—¥å†…ï¼Œå¦‚å¯¹å•†å“/æœåŠ¡ä¸æ»¡æ„ï¼Œå‡å¯ç”³è¯·é€€æ¬¾ï¼Œæ— éœ€è¯´æ˜ç†ç”±ã€‚
2. **é€€æ¬¾æ—¶é™**ï¼šé€€æ¬¾ç”³è¯·æäº¤åï¼Œæˆ‘æ–¹æ‰¿è¯º1ä¸ªå·¥ä½œæ—¥å†…å®Œæˆå®¡æ ¸ï¼Œå®¡æ ¸é€šè¿‡å3ä¸ªå·¥ä½œæ—¥å†…å®Œæˆé€€æ¬¾ï¼Œæ¬¾é¡¹åŸè·¯é€€å›è‡³æ¶ˆè´¹è€…æ”¯ä»˜è´¦æˆ·ã€‚
3. **é€€æ¬¾æµç¨‹**ï¼šæ¶ˆè´¹è€…é€šè¿‡å¾®ä¿¡å®¢æœ/å°ç¨‹åºå”®åå…¥å£æäº¤é€€æ¬¾ç”³è¯· â†’ å”®åå®¢æœ1ä¸ªå·¥ä½œæ—¥å†…å®¡æ ¸ â†’ å®¡æ ¸é€šè¿‡åå‘èµ·é€€æ¬¾ â†’ åŸè·¯é€€å›ã€‚
4. **é€€æ¬¾æ–¹å¼**ï¼šç»Ÿä¸€é‡‡ç”¨å¾®ä¿¡æ”¯ä»˜åŸè·¯é€€å›æ–¹å¼ï¼Œç¡®ä¿èµ„é‡‘å®‰å…¨å¯è¿½æº¯ã€‚
5. **ç‰¹æ®Šæƒ…å†µå¤„ç†**ï¼šå¯¹äºäº‰è®®æ€§è®¢å•ï¼Œä¼˜å…ˆä»¥å‹å¥½åå•†æ–¹å¼è§£å†³ï¼Œä¿éšœæ¶ˆè´¹è€…åˆæ³•æƒç›Šã€‚

---

### ğŸ“„ ä¸‰ã€æŠ•è¯‰ç”ŸæˆåŸå› åŠè¯¦æƒ…

${violationAnalysis}

æˆ‘æ–¹æ·±åˆ»è®¤è¯†åˆ°åˆè§„ç»è¥çš„é‡è¦æ€§ï¼Œå¯¹äºæ­¤æ¬¡å¤„ç½šé«˜åº¦é‡è§†ã€‚æˆ‘æ–¹å·²å®Œæˆå…¨é¢è‡ªæŸ¥å¹¶ç§¯ææ•´æ”¹ï¼Œæ‰¿è¯ºåç»­å°†ä¸¥æ ¼æŒ‰ç…§å¹³å°è§„åˆ™ç»è¥ï¼Œæœç»ç±»ä¼¼é—®é¢˜å†æ¬¡å‘ç”Ÿã€‚æ³è¯·å¾®ä¿¡æ”¯ä»˜å›¢é˜Ÿç»¼åˆè€ƒé‡æˆ‘æ–¹çš„æ•´æ”¹æ€åº¦å’Œå®é™…è¡ŒåŠ¨ï¼Œäºˆä»¥é‡æ–°å®¡æ ¸ã€‚

---

### ğŸ“„ å››ã€ä¸šåŠ¡æ¨¡å¼

${hasBusiness ? `æˆ‘æ–¹ç»è¥æƒ…å†µå¦‚ä¸‹ï¼š${d.business}\n\n` : ''}æˆ‘æ–¹ä»äº‹åˆæ³•åˆè§„çš„å•†å“/æœåŠ¡ç»è¥ï¼Œæ‰€æœ‰äº¤æ˜“å‡ä¸ºçœŸå®ä¸šåŠ¡å¾€æ¥ã€‚ä¸»è¦ç»è¥æ¨¡å¼ï¼š

1. **ç»è¥ä¸»ä½“**ï¼šä¾æ³•æ³¨å†Œçš„åˆè§„ç»è¥ä¸»ä½“ï¼Œå…·å¤‡å®Œæ•´çš„ç»è¥èµ„è´¨ã€‚
2. **ä¸»è¥ä¸šåŠ¡**ï¼š${hasBusiness ? d.business.slice(0, 50) : 'åˆæ³•åˆè§„çš„å•†å“é›¶å”®/æœåŠ¡æä¾›'}ï¼Œé¢å‘çœŸå®æ¶ˆè´¹è€…æä¾›ä¼˜è´¨äº§å“å’ŒæœåŠ¡ã€‚
3. **ç»è¥åœºæ™¯**ï¼šé€šè¿‡å¾®ä¿¡å°ç¨‹åº/H5å•†åŸ/çº¿ä¸‹é—¨åº—å¼€å±•ç»è¥ï¼Œäº¤æ˜“æµç¨‹å…¬å¼€é€æ˜ã€‚
4. **äº¤æ˜“æµç¨‹**ï¼šå®¢æˆ·æµè§ˆå•†å“ â†’ å’¨è¯¢å®¢æœ â†’ ç¡®è®¤ä¸‹å• â†’ å¾®ä¿¡æ”¯ä»˜ â†’ å‘è´§/æä¾›æœåŠ¡ â†’ ç¡®è®¤æ”¶è´§/æœåŠ¡å®Œæˆã€‚
5. **å®¢æˆ·ç¾¤ä½“**ï¼šé¢å‘å¤§ä¼—æ¶ˆè´¹è€…ï¼Œå®¢æˆ·æ¥æºçœŸå®ï¼Œäº¤æ˜“è¡Œä¸ºè‡ªä¸»è‡ªæ„¿ã€‚

---

### ğŸ“„ äº”ã€æ•´æ”¹è¯´æ˜

ä¸ºæœç»ç±»ä¼¼é—®é¢˜å†æ¬¡å‘ç”Ÿï¼Œæˆ‘æ–¹åˆ¶å®šå¹¶å·²å¼€å§‹æ‰§è¡Œä»¥ä¸‹æ•´æ”¹æ–¹æ¡ˆï¼š

**ä¸€ã€å·²å®Œæˆæ•´æ”¹ï¼ˆç«‹å³æ‰§è¡Œï¼‰**
- å¯¹æ‰€æœ‰æœªå¤„ç†æŠ•è¯‰è¿›è¡Œ100%æ’æŸ¥å¤„ç†ï¼Œç¡®ä¿æŠ•è¯‰æ¸…é›¶
- å…¨é¢å®¡æ ¸å•†å“/æœåŠ¡æè¿°ä¿¡æ¯ï¼Œç¡®ä¿å†…å®¹å‡†ç¡®ã€æ— å¤¸å¤§å®£ä¼ 
- ä¼˜åŒ–å®¢æœå“åº”æœºåˆ¶ï¼Œç¡®ä¿æŠ•è¯‰30åˆ†é’Ÿå†…é¦–æ¬¡å“åº”

**äºŒã€åç»­æ•´æ”¹è®¡åˆ’ï¼ˆ1-2å‘¨å†…å®Œæˆï¼‰**
- å»ºç«‹æ¯æ—¥æŠ•è¯‰ç‡ç›‘æ§é¢„è­¦ç³»ç»Ÿï¼Œè¶…è¿‡ä¸‡åˆ†ä¹‹10å³å¯åŠ¨åº”æ€¥å“åº”
- å®Œå–„è®¢å•ç®¡ç†ç³»ç»Ÿï¼Œç¡®ä¿æ¯ç¬”äº¤æ˜“å…¨æµç¨‹å¯è¿½æº¯
- æ¯å‘¨å¬å¼€å”®åæœåŠ¡å¤ç›˜ä¼šè®®ï¼ŒæŒç»­æ”¹è¿›æœåŠ¡è´¨é‡

**ä¸‰ã€é•¿æœŸåˆè§„æ‰¿è¯º**
- ä¸¥æ ¼éµå®ˆã€Šå¾®ä¿¡æ”¯ä»˜å•†æˆ·æœåŠ¡åè®®ã€‹åŠå¹³å°å„é¡¹è§„åˆ™
- å®šæœŸè¿›è¡Œåˆè§„ç»è¥è‡ªæŸ¥ï¼Œä¸»åŠ¨å‘ç°å¹¶çº æ­£é—®é¢˜
- æŒç»­ä¼˜åŒ–äº§å“å’ŒæœåŠ¡è´¨é‡ï¼Œæå‡å®¢æˆ·æ»¡æ„åº¦

æˆ‘æ–¹æ‰¿è¯ºä»¥ä¸Šæ•´æ”¹æªæ–½å°†ä¸¥æ ¼æ‰§è¡Œåˆ°ä½ã€‚æ³è¯·å¾®ä¿¡æ”¯ä»˜å›¢é˜Ÿå®¡æ ¸é€šè¿‡ï¼Œæ¢å¤æˆ‘æ–¹æ­£å¸¸äº¤æ˜“åŠŸèƒ½ã€‚å¦‚éœ€è¡¥å……ä»»ä½•ææ–™ï¼Œæˆ‘æ–¹éšæ—¶é…åˆæä¾›ã€‚

---

### ğŸ“‹ ç”³è¯‰æäº¤æŒ‡å—

**æ–¹å¼ä¸€ï¼ˆæ¨èï¼‰**ï¼šå¾®ä¿¡æœç´¢ã€Œå¾®ä¿¡æ”¯ä»˜å•†å®¶åŠ©æ‰‹ã€â†’ æˆ‘æ˜¯å•†å®¶ â†’ é£é™©å¤„ç† â†’ åŠŸèƒ½é™åˆ¶è®°å½• â†’ å‘èµ·ç”³è¯‰

**æ–¹å¼äºŒ**ï¼šç™»å½• pay.weixin.qq.com â†’ è´¦æˆ·ä¸­å¿ƒ â†’ è¿çº¦è®°å½• â†’ æäº¤ç”³è¯‰

**æ³¨æ„äº‹é¡¹**ï¼šè¯ä»¶ç…§ç‰‡åŠ¡å¿…æ¸…æ™°ã€è®¢å•å·ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜è®¢å•å·ï¼ˆ4å¼€å¤´28ä½ï¼‰ã€è¡¥å……èµ„æ–™é€šé“é€šå¸¸ä»…å¼€æ”¾24å°æ—¶ã€å®¡æ ¸å‘¨æœŸ3-5ä¸ªå·¥ä½œæ—¥ã€‚å¦‚æœ‰ç–‘é—®å¯æ‹¨æ‰“ **95017**ã€‚

---

ä»¥ä¸Šææ–™å·²æ ¹æ®æ‚¨çš„å®é™…æƒ…å†µå®šåˆ¶ç”Ÿæˆï¼Œæ¯éƒ¨åˆ†å¯ç‹¬ç«‹å¤åˆ¶ä½¿ç”¨ã€‚å¦‚éœ€ä¿®æ”¹ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ï¼`
}

// ========== AI å…¨æµç¨‹å¯¹è¯ï¼ˆæœ‰ AI æ—¶ï¼šAI å¤„ç†æ‰€æœ‰é˜¶æ®µçš„å¯¹è¯ï¼‰ ==========

/**
 * AI å¤„ç†å®Œæ•´å¯¹è¯ï¼šè¯Šæ–­ã€å›ç­”é—®é¢˜ã€è¯„ä¼°æŠ¥ä»·ã€ç”Ÿæˆææ–™ã€åç»­ä¿®æ”¹
 * å°†å®Œæ•´èŠå¤©å†å²å‘ç»™ DeepSeekï¼Œç”± AI è‡ªç„¶åœ°æ¨è¿›å¯¹è¯
 */
export async function chatWithAI(chatHistory, customApiKey, collectedData = {}) {
  try {
    const result = await callDeepSeek(chatHistory, customApiKey, collectedData)
    if (result) {
      return {
        response: result.content,
        usedAI: true,
        inputTokens: result.inputTokens,
        outputTokens: result.outputTokens,
      }
    }
  } catch (err) {
    console.error('DeepSeek chat failed:', err.message)
    return { error: err.message }
  }
  return null
}

/**
 * æµå¼ AI å¯¹è¯ï¼šè¿”å› DeepSeek çš„ SSE æµï¼Œä¾›è·¯ç”±å±‚ç›´æ¥ pipe ç»™å‰ç«¯
 */
export async function streamChatWithAI(chatHistory, customApiKey, collectedData = {}) {
  const apiKey = customApiKey || await getSystemConfig('deepseek_api_key')
  if (!apiKey) throw new Error('NO_API_KEY')

  const model = (await getSystemConfig('deepseek_model')) || 'deepseek-chat'
  const temp = parseFloat((await getSystemConfig('ai_temperature')) || '0.7')

  const systemPrompt = buildSystemPrompt(collectedData)
  const messages = [
    { role: 'system', content: systemPrompt },
    ...chatHistory.map(m => ({
      role: m.role === 'admin' ? 'assistant' : (m.role === 'user' ? 'user' : 'assistant'),
      content: m.content,
    })),
  ]

  const controller = new AbortController()
  const timeout = setTimeout(() => controller.abort(), 60000)

  const res = await fetch('https://api.deepseek.com/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey}`,
    },
    body: JSON.stringify({ model, messages, temperature: temp, max_tokens: 4096, stream: true }),
    signal: controller.signal,
  })
  clearTimeout(timeout)

  if (!res.ok) {
    const errText = await res.text()
    console.error('DeepSeek stream error:', res.status, errText)
    if (res.status === 401) throw new Error('API_KEY_INVALID')
    if (res.status === 402) throw new Error('API_BALANCE_INSUFFICIENT')
    if (res.status === 429) throw new Error('API_RATE_LIMIT')
    throw new Error(`API_ERROR_${res.status}`)
  }

  // è¿”å›åŸå§‹å“åº”ä½“å’Œ inputTokens ä¼°ç®—
  const inputTokens = countMessagesTokens(messages)
  return { body: res.body, inputTokens }
}

// ========== DeepSeek æ™ºèƒ½å­—æ®µæå–ï¼ˆä»æ··ä¹±è¾“å…¥ä¸­æŠ“å–æœ‰ç”¨ä¿¡æ¯ï¼‰ ==========

/**
 * ç”¨ DeepSeek ä»ç”¨æˆ·çš„æ··ä¹±/ç­”éæ‰€é—®/åŠå¥è¯è¾“å…¥ä¸­æå–ç»“æ„åŒ–å­—æ®µ
 * è½»é‡çº§ JSON è°ƒç”¨ï¼Œä¸èµ°æµå¼ï¼Œå¿«é€Ÿè¿”å›
 * @param {string} userMessage - ç”¨æˆ·åŸå§‹æ¶ˆæ¯
 * @param {object} collectedData - å·²æ”¶é›†çš„æ•°æ®
 * @param {number} currentStep - å½“å‰æ­¥éª¤
 * @param {string} customApiKey - å¯é€‰çš„è‡ªå®šä¹‰ API Key
 * @param {Array} recentHistory - æœ€è¿‘å‡ æ¡å¯¹è¯è®°å½•ï¼ˆæä¾›ä¸Šä¸‹æ–‡ï¼‰
 * @returns {object} { extracted: {field: value}, intent: string } æˆ– null
 */
export async function extractFieldsWithAI(userMessage, collectedData = {}, currentStep = 0, customApiKey = null, recentHistory = []) {
  const apiKey = customApiKey || await getSystemConfig('deepseek_api_key')
  if (!apiKey) return null

  const model = (await getSystemConfig('deepseek_model')) || 'deepseek-chat'

  // æ„å»ºå·²æ”¶é›†/æœªæ”¶é›†å­—æ®µæ‘˜è¦
  const fieldDefs = [
    { key: 'industry', label: 'ä¸šåŠ¡ç±»å‹', hint: 'å¦‚ï¼šé¤é¥®ã€æ¸¸æˆã€é™ªç©ã€æ•™è‚²ã€ç”µå•†ã€SaaSç­‰', example: 'æˆ‘æ˜¯åšé™ªç©çš„â†’é™ªç©ç¤¾äº¤' },
    { key: 'business_model', label: 'ç»è¥æ¨¡å¼', hint: 'çº¯çº¿ä¸Š/çº¿ä¸‹é—¨åº—/çº¿ä¸Šçº¿ä¸‹ç»“åˆ', example: 'å°ç¨‹åºå–ä¸œè¥¿â†’çº¯çº¿ä¸Šï¼ˆå°ç¨‹åº/å…¬ä¼—å·/H5ï¼‰' },
    { key: 'problem_type', label: 'å¤„ç½šç±»å‹', hint: 'äº¤æ˜“æ‹¦æˆª/æ”¶æ¬¾é™é¢/æ”¯ä»˜æƒé™å…³é—­/èµ„é‡‘å†»ç»“/å•†æˆ·å·å°ç¦', example: 'è¢«å°äº†â†’å•†æˆ·å·å°ç¦' },
    { key: 'violation_reason', label: 'è¿è§„åŸå› ', hint: 'å¾®ä¿¡å®˜æ–¹ç»™å‡ºçš„è¿è§„åŸå› ', example: 'è¯´æˆ‘å¥—ç°â†’æ¶‰å«Œä¿¡ç”¨å¡å¥—ç°' },
    { key: 'merchant_id', label: 'å•†æˆ·å·', hint: '10ä½æ•°å­—', example: '1409570162' },
    { key: 'merchant_name', label: 'å•†æˆ·åç§°', hint: 'å¾®ä¿¡æ”¯ä»˜æ³¨å†Œåç§°', example: 'è‰¾é˜³ç½‘ç»œ' },
    { key: 'company_name', label: 'å…¬å¸å…¨ç§°', hint: 'è¥ä¸šæ‰§ç…§ä¸Šçš„å…¨ç§°', example: 'XXç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸' },
    { key: 'license_no', label: 'ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ', hint: '18ä½å­—æ¯+æ•°å­—', example: '91110105MA5XXXXXX7' },
    { key: 'legal_name', label: 'æ³•äººå§“å', hint: 'è¥ä¸šæ‰§ç…§ä¸Šçš„æ³•å®šä»£è¡¨äºº', example: 'å¼ ä¸‰' },
    { key: 'legal_id_last4', label: 'èº«ä»½è¯åå››ä½', hint: '4ä½æ•°å­—æˆ–3ä½æ•°å­—+X', example: '5678' },
    { key: 'complaint_status', label: 'æŠ•è¯‰æƒ…å†µ', hint: 'æœ‰æ— æŠ•è¯‰/æŠ•è¯‰æ•°é‡/æŠ•è¯‰åŸå› ', example: 'æœ‰5ä¸ªæŠ•è¯‰â†’æœ‰5ä¸ªæœªå¤„ç†æŠ•è¯‰' },
    { key: 'refund_policy', label: 'é€€æ¬¾æ”¿ç­–', hint: 'é€€æ¬¾æµç¨‹å’Œè§„åˆ™', example: '7å¤©æ— ç†ç”±â†’7å¤©æ— ç†ç”±é€€æ¬¾' },
    { key: 'bank_name', label: 'å¼€æˆ·é“¶è¡Œ', hint: 'ç»“ç®—è´¦æˆ·é“¶è¡Œ', example: 'å·¥å•†é“¶è¡Œ' },
    { key: 'bank_account_last4', label: 'ç»“ç®—è´¦æˆ·åå››ä½', hint: '4ä½æ•°å­—', example: '1234' },
    { key: 'contact_phone', label: 'è”ç³»ç”µè¯', hint: '11ä½æ‰‹æœºå·', example: '13812345678' },
    { key: 'appeal_history', label: 'ç”³è¯‰å†å²', hint: 'æ˜¯å¦ç”³è¯‰è¿‡/å‡ æ¬¡/ç»“æœ', example: 'è¯•è¿‡ä¸¤æ¬¡è¢«é©³å›â†’ç”³è¯‰è¿‡2æ¬¡ï¼Œå‡è¢«é©³å›' },
  ]

  // åˆå¹¶åŠ¨æ€å­—æ®µï¼ˆè¡Œä¸šè‡ªé€‚åº”ç”Ÿæˆçš„ï¼‰
  const dynamicFields = (collectedData._dynamic_fields || []).map(df => ({
    key: df.key, label: df.label, hint: df.hint || df.question || df.label, example: df.hint || ''
  }))
  const allFields = [...fieldDefs, ...dynamicFields]

  const collected = allFields
    .filter(f => collectedData[f.key] && !String(collectedData[f.key]).startsWith('ç”¨æˆ·æš‚æœªæä¾›'))
    .map(f => `${f.key}(${f.label}): "${collectedData[f.key]}"`)
    .join('\n')

  const missing = allFields
    .filter(f => !collectedData[f.key] || String(collectedData[f.key]).startsWith('ç”¨æˆ·æš‚æœªæä¾›'))
    .map(f => `${f.key}: ${f.label} â€” ${f.hint}${f.example ? `ï¼ˆä¾‹ï¼š${f.example}ï¼‰` : ''}`)
    .join('\n')

  // æœ€è¿‘å¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆå¸®åŠ©ç†è§£ç”¨æˆ·åœ¨å›ç­”ä»€ä¹ˆï¼‰
  const contextMsgs = recentHistory.slice(-6).map(m =>
    `${m.role === 'user' ? 'ç”¨æˆ·' : 'AI'}: ${m.content.substring(0, 200)}`
  ).join('\n')

  const prompt = `ä½ æ˜¯å•†æˆ·å·ç”³è¯‰å…¨æµç¨‹æ™ºèƒ½ä¸“å®¶AIçš„ä¿¡æ¯æå–æ¨¡å—ã€‚ä»ç”¨æˆ·æ¶ˆæ¯ä¸­æå–å•†æˆ·ç”³è¯‰ç›¸å…³çš„ã€å…·ä½“äº‹å®æ•°æ®ã€‘ã€‚
è¦†ç›–å¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å®ã€æŠ–éŸ³ã€å¿«æ‰‹ã€ç¾å›¢ç­‰å…¨å¹³å°å•†æˆ·å·ç”³è¯‰åœºæ™¯ã€‚

## å·²æ”¶é›†çš„ä¿¡æ¯
${collected || 'ï¼ˆæš‚æ— ï¼‰'}

## è¿˜éœ€è¦æ”¶é›†çš„å­—æ®µ
${missing || 'ï¼ˆå…¨éƒ¨å·²æ”¶é›†ï¼‰'}

## æœ€è¿‘å¯¹è¯ä¸Šä¸‹æ–‡
${contextMsgs || 'ï¼ˆæ— å†å²ï¼‰'}

## ç”¨æˆ·æœ€æ–°æ¶ˆæ¯
"${userMessage}"

## æå–è§„åˆ™
1. ä»ç”¨æˆ·æ¶ˆæ¯ä¸­è¯†åˆ«èƒ½åŒ¹é…å­—æ®µçš„ã€å…·ä½“æ•°æ®ã€‘ï¼Œå·²æ”¶é›†å­—æ®µå’Œæœªæ”¶é›†å­—æ®µéƒ½è¦æ£€æŸ¥
2. ç”¨æˆ·è¡¨è¾¾å¯èƒ½æå…¶æ··ä¹±ï¼šç­”éæ‰€é—®ã€è¯´åŠå¥è¯ã€å¤šä¸ªä¿¡æ¯æ··åœ¨ä¸€èµ·ã€å£è¯­åŒ–ã€å¸¦æƒ…ç»ªâ€”â€”ä½ è¦åœ¨æ··ä¹±ä¸­ç²¾å‡†æ‰¾åˆ°æœ‰ç”¨æ•°æ®
3. å£è¯­åŒ–ç¿»è¯‘ï¼šç”¨æˆ·è¯´"è¢«å°äº†"=å•†æˆ·å·å°ç¦ï¼Œ"ä¸èƒ½æ”¶æ¬¾"=æ”¯ä»˜æƒé™å…³é—­ï¼Œ"é’±å–ä¸å‡ºæ¥"=èµ„é‡‘å†»ç»“ï¼Œ"åº—è¢«å…³äº†"=åº—é“ºå°ç¦ï¼Œ"æç°ä¸äº†"=èµ„é‡‘å†»ç»“
4. å¤šå¹³å°è¯†åˆ«ï¼šç”¨æˆ·æåˆ°"å¾®ä¿¡""æ”¯ä»˜å®""æŠ–éŸ³""å¿«æ‰‹""ç¾å›¢"ç­‰å¹³å°åâ†’è¯†åˆ«ä¸ºå¯¹åº”å¹³å°ç±»å‹
5. æ™ºèƒ½è¿è§„è¯Šæ–­ï¼šäº¤æ˜“å¼‚å¸¸ã€èµ„é‡‘å†»ç»“ã€è¿è§„é£æ§ã€æŠ•è¯‰è¿‡å¤šã€å¼‚åœ°æ”¶æ¬¾ã€å†…å®¹è¿è§„ç­‰ï¼Œç²¾å‡†åŒ¹é…è¿è§„ç±»å‹
6. å¦å®šå›ç­”æ˜¯æœ‰æ•ˆæ•°æ®ï¼šç”¨æˆ·è¯´"æ²¡æœ‰"/"ä¸çŸ¥é“"â†’æŠ•è¯‰æƒ…å†µ="æ²¡æœ‰æœªå¤„ç†æŠ•è¯‰"ï¼Œé€€æ¬¾æ”¿ç­–="æš‚æ— å®Œå–„é€€æ¬¾æ”¿ç­–"ï¼Œç”³è¯‰å†å²="é¦–æ¬¡ç”³è¯‰"
7. ä¸€æ¡æ¶ˆæ¯å«å¤šä¸ªå­—æ®µä¿¡æ¯â†’å…¨éƒ¨æå–ï¼Œä¸è¦é—æ¼
8. åªæå–æœ‰æŠŠæ¡çš„ï¼Œä¸ç¡®å®šçš„ä¸æå–
9. ä¸¥ç¦ç¼–é€ ç”¨æˆ·æ²¡è¯´çš„ä¿¡æ¯

## ã€ä¿¡æ¯ä¿®æ­£æ£€æµ‹ â€” æå…¶é‡è¦ã€‘
âœ… ç”¨æˆ·çº æ­£å·²æœ‰ä¿¡æ¯æ—¶ï¼Œcorrectionå¿…é¡»è®¾ä¸ºtrueï¼Œå¹¶æå–ä¿®æ­£åçš„å€¼ï¼š
- "ä¸æ˜¯XXï¼Œæ˜¯YY" â†’ æå–YYï¼Œcorrection=true
- "ä¹‹å‰è¯´é”™äº†ï¼Œåº”è¯¥æ˜¯YY" â†’ æå–YYï¼Œcorrection=true
- "æ”¹ä¸€ä¸‹ï¼Œè¡Œä¸šæ˜¯YY" â†’ æå–YYï¼Œcorrection=true
- ç”¨æˆ·å¯¹å·²æ”¶é›†å­—æ®µç»™å‡ºä¸åŒçš„å€¼ â†’ ä»¥æ–°å€¼ä¸ºå‡†ï¼Œcorrection=true
âœ… ä¿®æ­£å¯ä»¥é’ˆå¯¹ä»»ä½•å·²æ”¶é›†å­—æ®µï¼Œä¸é™äºå½“å‰æ­£åœ¨è¯¢é—®çš„å­—æ®µ

## ã€ä¸¥æ ¼è¿‡æ»¤ â€” é˜²æ­¢è¯¯æå–ã€‘
â›” ä»¥ä¸‹ç»ä¸æ˜¯å­—æ®µæ•°æ®ï¼Œä¸¥ç¦æå–ï¼š
- æé—®å¥ï¼ˆ"æ€ä¹ˆè§£å°""è¿˜æœ‰ä»€ä¹ˆé—®é¢˜""ä¸‹ä¸€æ­¥æ€ä¹ˆåš""å¯ä»¥ä¸Šç½‘å—""ç°åœ¨å‡ ç‚¹äº†"ï¼‰
- å‚¬ä¿ƒ/æŠ±æ€¨ï¼ˆ"å¿«ç‚¹""ä¸ºä»€ä¹ˆè¿™ä¹ˆæ…¢""æä¸æ‡‚"ï¼‰
- é—²èŠ/ç¡®è®¤/åº”ç­”ï¼ˆ"å¥½çš„""æ˜ç™½äº†""å¯ä»¥""å—¯"ï¼‰
- å¤è¿°AIçš„è¯ã€è®¨è®ºæµç¨‹ã€å¯¹AIçš„è¯„ä»·
- å¯¹AIè¯´è¯/è´¨ç–‘AIï¼ˆ"ä½ æ˜¯å‚»é€¼å§""ä¸æ˜¯ä¹±è®²""ä½ é”™äº†""è®¤çœŸæ€è€ƒ"ï¼‰
- ç”¨æˆ·åé©³/çº æ­£AIï¼ˆ"ä¸æ˜¯è¿™æ ·""æˆ‘æ²¡è¯´è¿‡""è¯´çš„ä¸å¯¹""çè¯´"ï¼‰
- è„è¯/æƒ…ç»ªå®£æ³„ï¼ˆéª‚äººçš„è¯ç»ä¸æ˜¯ä¸šåŠ¡æ•°æ®ï¼ï¼‰

â›” å­—æ®µå€¼=å…·ä½“äº‹å®æ•°æ®ï¼Œä¸èƒ½æ˜¯ç–‘é—®å¥/æ„Ÿå¹å¥/æƒ…ç»ªè¡¨è¾¾/å¯¹AIçš„è¯
â›” industryåªèƒ½æ˜¯çœŸå®è¡Œä¸šï¼ˆé¤é¥®/é›¶å”®/æ¸¸æˆç­‰ï¼‰ï¼Œ"å¯ä»¥ä¸Šç½‘å—ä½ "ä¸æ˜¯è¡Œä¸šï¼
â›” business_modelåªèƒ½æ˜¯ç»è¥æ¨¡å¼ï¼ˆçº¿ä¸Š/çº¿ä¸‹/çº¿ä¸Š+çº¿ä¸‹ï¼‰ï¼Œ"ä¸æ˜¯ä¹±è®²"ä¸æ˜¯ç»è¥æ¨¡å¼ï¼
â›” bank_nameåªèƒ½æ˜¯é“¶è¡Œåç§°ï¼ˆå·¥å•†é“¶è¡Œã€å»ºè®¾é“¶è¡Œç­‰ï¼‰ï¼Œä¸èƒ½æ˜¯æé—®æˆ–å…¶ä»–æ–‡å­—
â›” å¦‚æœç”¨æˆ·æ˜æ˜¾ä¸æ˜¯åœ¨å›ç­”ä¸šåŠ¡é—®é¢˜ï¼ˆåœ¨èŠå¤©/è´¨ç–‘/éª‚äºº/åé©³ï¼‰ï¼Œextractedå¿…é¡»ä¸ºç©º{}
â›” æ— å…·ä½“æ•°æ®æ—¶extractedå¿…é¡»ä¸ºç©º{}

è¿”å›ä¸¥æ ¼JSONï¼š
{"extracted":{"å­—æ®µkey":"æå–çš„å€¼"},"intent":"ç®€è¿°ç”¨æˆ·æ„å›¾","correction":false}
correction=trueè¡¨ç¤ºç”¨æˆ·åœ¨çº æ­£/ä¿®æ”¹ä¹‹å‰çš„ä¿¡æ¯ã€‚æ— å¯æå–ä¿¡æ¯æ—¶extracted={}ã€‚`

  try {
    const controller = new AbortController()
    const timeout = setTimeout(() => controller.abort(), 15000) // 15ç§’è¶…æ—¶

    const res = await fetch('https://api.deepseek.com/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model,
        messages: [{ role: 'user', content: prompt }],
        temperature: 0.1, // ä½æ¸©åº¦ç¡®ä¿å‡†ç¡®æå–
        max_tokens: 512,
        response_format: { type: 'json_object' },
      }),
      signal: controller.signal,
    })
    clearTimeout(timeout)

    if (!res.ok) {
      console.error('DeepSeek extraction error:', res.status)
      return null
    }

    const data = await res.json()
    const content = data.choices?.[0]?.message?.content
    if (!content) return null

    const parsed = JSON.parse(content)
    const usage = data.usage || {}

    console.log(`[AIæå–] è¾“å…¥: "${userMessage.substring(0, 50)}..." â†’ æå–: ${JSON.stringify(parsed.extracted || {})} | æ„å›¾: ${parsed.intent || ''}`)

    return {
      extracted: parsed.extracted || {},
      intent: parsed.intent || '',
      correction: parsed.correction || false,
      inputTokens: usage.prompt_tokens || 0,
      outputTokens: usage.completion_tokens || 0,
    }
  } catch (err) {
    console.error('DeepSeek extraction failed:', err.message)
    return null
  }
}

// ========== è¡Œä¸šè‡ªé€‚åº”å­—æ®µæ‰©å±• ==========

/**
 * å½“è¡Œä¸šè¢«è¯†åˆ«åï¼Œè®© DeepSeek ç”Ÿæˆè¯¥è¡Œä¸šç‰¹æœ‰çš„é¢å¤–ä¿¡æ¯éœ€æ±‚
 * ä¸€æ¬¡æ€§è°ƒç”¨ï¼Œç»“æœç¼“å­˜åœ¨ session çš„ _dynamic_fields ä¸­
 */
export async function expandFieldsForIndustry(industry, problemType, collectedData = {}, customApiKey = null) {
  const apiKey = customApiKey || await getSystemConfig('deepseek_api_key')
  if (!apiKey) return null

  const model = (await getSystemConfig('deepseek_model')) || 'deepseek-chat'

  const prompt = `ä½ æ˜¯å•†æˆ·ç”³è¯‰ä¿¡æ¯åˆ†æå¸ˆã€‚æ ¹æ®è¡Œä¸šå’Œé—®é¢˜ç±»å‹ï¼Œåˆ—å‡ºè¯¥è¡Œä¸šç”³è¯‰éœ€è¦é¢å¤–æ”¶é›†çš„ä¿¡æ¯ã€‚

è¡Œä¸šï¼š${industry}
é—®é¢˜ç±»å‹ï¼š${problemType || 'å¾…ç¡®è®¤'}

åŸºç¡€å­—æ®µï¼ˆå·²å®šä¹‰ï¼Œä¸è¦é‡å¤ï¼‰ï¼šä¸šåŠ¡ç±»å‹ã€ç»è¥æ¨¡å¼ã€å¤„ç½šç±»å‹ã€è¿è§„åŸå› ã€å•†æˆ·å·ã€å•†æˆ·åç§°ã€å…¬å¸å…¨ç§°ã€ä¿¡ç”¨ä»£ç ã€æ³•äººå§“åã€èº«ä»½è¯åå››ä½ã€æŠ•è¯‰æƒ…å†µã€é€€æ¬¾æ”¿ç­–ã€å¼€æˆ·é“¶è¡Œã€ç»“ç®—è´¦æˆ·åå››ä½ã€è”ç³»ç”µè¯ã€ç”³è¯‰å†å²

è¯·è¿”å›è¯¥è¡Œä¸šç‰¹æœ‰çš„3-6ä¸ªé¢å¤–ä¿¡æ¯é¡¹ï¼Œè¿™äº›ä¿¡æ¯èƒ½è®©ç”³è¯‰ææ–™æ›´æœ‰é’ˆå¯¹æ€§ã€‚

è¿”å›ä¸¥æ ¼JSONï¼š
{"fields":[{"key":"å­—æ®µkey_è‹±æ–‡è›‡å½¢","label":"ä¸­æ–‡åç§°","group":"è¡Œä¸šä¿¡æ¯","icon":"ğŸ­","question":"å‘ç”¨æˆ·æé—®çš„è¯æœ¯","hint":"ç®€çŸ­è¯´æ˜"},{"key":"..."}],"industry_tip":"è¯¥è¡Œä¸šç”³è¯‰çš„1-2å¥å…³é”®æç¤º"}

ç¤ºä¾‹ï¼ˆæ¸¸æˆè¡Œä¸šï¼‰ï¼š
{"fields":[{"key":"game_type","label":"æ¸¸æˆç±»å‹","group":"è¡Œä¸šä¿¡æ¯","icon":"ğŸ®","question":"æ‚¨çš„æ¸¸æˆå±äºå“ªç§ç±»å‹ï¼Ÿå¦‚ä¼‘é—²ã€ç«æŠ€ã€RPGã€æ£‹ç‰Œç­‰","hint":"æ¸¸æˆç±»å‹"},{"key":"daily_active_users","label":"æ—¥æ´»è·ƒç”¨æˆ·æ•°","group":"è¡Œä¸šä¿¡æ¯","icon":"ğŸ“Š","question":"å¤§æ¦‚æœ‰å¤šå°‘æ—¥æ´»è·ƒç”¨æˆ·ï¼Ÿ","hint":"DAUæ•°é‡"},{"key":"payment_model","label":"ä»˜è´¹æ¨¡å¼","group":"è¡Œä¸šä¿¡æ¯","icon":"ğŸ’°","question":"æ¸¸æˆçš„ä»˜è´¹æ¨¡å¼æ˜¯ä»€ä¹ˆï¼Ÿå¦‚å…è´¹+å†…è´­ã€ä¹°æ–­åˆ¶ã€è®¢é˜…åˆ¶ç­‰","hint":"å˜ç°æ–¹å¼"}],"industry_tip":"æ¸¸æˆè¡Œä¸šç”³è¯‰é‡ç‚¹æ˜¯è¯æ˜å†…å®¹åˆè§„å’Œä»˜è´¹æ¨¡å¼é€æ˜"}`

  try {
    const controller = new AbortController()
    const timeout = setTimeout(() => controller.abort(), 15000)

    const res = await fetch('https://api.deepseek.com/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
      body: JSON.stringify({
        model,
        messages: [{ role: 'user', content: prompt }],
        temperature: 0.3,
        max_tokens: 1024,
        response_format: { type: 'json_object' },
      }),
      signal: controller.signal,
    })
    clearTimeout(timeout)

    if (!res.ok) return null
    const data = await res.json()
    const content = data.choices?.[0]?.message?.content
    if (!content) return null

    const parsed = JSON.parse(content)
    const usage = data.usage || {}
    console.log(`[è¡Œä¸šæ‰©å±•] ${industry} â†’ ${parsed.fields?.length || 0}ä¸ªé¢å¤–å­—æ®µ | tip: ${parsed.industry_tip || ''}`)

    return {
      fields: (parsed.fields || []).map(f => ({ ...f, group: f.group || 'è¡Œä¸šä¿¡æ¯', icon: f.icon || 'ğŸ­', dynamic: true })),
      industryTip: parsed.industry_tip || '',
      inputTokens: usage.prompt_tokens || 0,
      outputTokens: usage.completion_tokens || 0,
    }
  } catch (err) {
    console.error('Industry expansion failed:', err.message)
    return null
  }
}

// ========== AI æ™ºèƒ½å®Œæˆåº¦è¯„ä¼° ==========

/**
 * è®© DeepSeek åˆ¤æ–­å·²æ”¶é›†çš„ä¿¡æ¯æ˜¯å¦è¶³å¤Ÿç”Ÿæˆç”³è¯‰ææ–™
 * è¿”å› readiness score + ä¸‹ä¸€æ­¥å»ºè®®
 */
export async function assessCompletenessWithAI(collectedData = {}, customApiKey = null) {
  const apiKey = customApiKey || await getSystemConfig('deepseek_api_key')
  if (!apiKey) return { score: 0, ready: false }

  const model = (await getSystemConfig('deepseek_model')) || 'deepseek-chat'

  // æ„å»ºå·²æ”¶é›†ä¿¡æ¯æ‘˜è¦
  const info = Object.entries(collectedData)
    .filter(([k, v]) => !k.startsWith('_') && v && v.trim() && v !== 'ç”¨æˆ·æš‚æœªæä¾›' && v !== 'â³å¾…è¡¥å……')
    .map(([k, v]) => `${k}: ${v}`)
    .join('\n')

  const fieldCount = info.split('\n').filter(l => l.trim()).length

  const prompt = `ä½ æ˜¯å•†æˆ·ç”³è¯‰ä¿¡æ¯å®Œæ•´åº¦è¯„ä¼°å¸ˆã€‚åˆ¤æ–­ä»¥ä¸‹ä¿¡æ¯æ˜¯å¦è¶³å¤Ÿç”Ÿæˆä¸€ä»½æœ‰è´¨é‡çš„å¾®ä¿¡å•†æˆ·ç”³è¯‰ææ–™ã€‚

## å·²æ”¶é›†ä¿¡æ¯ï¼ˆå…±${fieldCount}é¡¹ï¼‰
${info || 'ï¼ˆæš‚æ— ï¼‰'}

## è¯„ä¼°æ ‡å‡†
1. æ ¸å¿ƒä¸‰è¦ç´ ï¼ˆè¡Œä¸š+å¤„ç½šç±»å‹+è¿è§„åŸå› ï¼‰æ˜¯å¦é½å…¨ï¼Ÿç¼ºä»»ä½•ä¸€ä¸ªéƒ½ä¸èƒ½ready
2. èº«ä»½ä¿¡æ¯ï¼ˆå•†æˆ·å· æˆ– å…¬å¸å æˆ– æ³•äººåï¼‰è‡³å°‘æœ‰ä¸€ä¸ªï¼Ÿ
3. æœ‰äº†æ ¸å¿ƒä¸‰è¦ç´ +èº«ä»½ä¿¡æ¯ï¼Œæ˜¯å¦èƒ½å†™å‡ºæœ‰é’ˆå¯¹æ€§çš„ç”³è¯‰ææ–™ï¼Ÿ
4. è¿˜æœ‰ä»€ä¹ˆå…³é”®ä¿¡æ¯ç¼ºå¤±ä¼šä¸¥é‡å½±å“ç”³è¯‰è´¨é‡ï¼Ÿ

## è¯„åˆ†è§„åˆ™
- 0-30ï¼šæ ¸å¿ƒä¿¡æ¯ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆ
- 31-60ï¼šæœ‰åŸºæœ¬ä¿¡æ¯ï¼Œå¯ä»¥ç”ŸæˆåŸºç¡€ç‰ˆä½†è´¨é‡ä¸é«˜
- 61-80ï¼šä¿¡æ¯è¾ƒå®Œæ•´ï¼Œå¯ä»¥ç”Ÿæˆæœ‰è´¨é‡çš„ç”³è¯‰ææ–™
- 81-100ï¼šä¿¡æ¯éå¸¸å……åˆ†ï¼Œå¯ä»¥ç”Ÿæˆé«˜è´¨é‡é’ˆå¯¹æ€§ææ–™

è¿”å›ä¸¥æ ¼JSONï¼š
{"score":0åˆ°100çš„æ•´æ•°,"ready":trueæˆ–false,"reason":"ä¸€å¥è¯è¯´æ˜åŸå› ","next_question":"å¦‚æœnot ready,å»ºè®®ä¸‹ä¸€ä¸ªè¦é—®çš„é—®é¢˜","missing_critical":["ç¼ºå¤±çš„å…³é”®ä¿¡æ¯"]}`

  try {
    const controller = new AbortController()
    const timeout = setTimeout(() => controller.abort(), 12000)

    const res = await fetch('https://api.deepseek.com/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
      body: JSON.stringify({
        model,
        messages: [{ role: 'user', content: prompt }],
        temperature: 0.1,
        max_tokens: 256,
        response_format: { type: 'json_object' },
      }),
      signal: controller.signal,
    })
    clearTimeout(timeout)

    if (!res.ok) return { score: 0, ready: false }
    const data = await res.json()
    const content = data.choices?.[0]?.message?.content
    if (!content) return { score: 0, ready: false }

    const parsed = JSON.parse(content)
    const usage = data.usage || {}
    console.log(`[å®Œæˆåº¦è¯„ä¼°] score=${parsed.score} ready=${parsed.ready} reason="${parsed.reason}" missing=${JSON.stringify(parsed.missing_critical || [])}`)

    return {
      score: parsed.score || 0,
      ready: parsed.ready || false,
      reason: parsed.reason || '',
      nextQuestion: parsed.next_question || '',
      missingCritical: parsed.missing_critical || [],
      inputTokens: usage.prompt_tokens || 0,
      outputTokens: usage.completion_tokens || 0,
    }
  } catch (err) {
    console.error('Completeness assessment failed:', err.message)
    return { score: 0, ready: false }
  }
}

// ========== å¯¼å‡º ==========

export function processUserMessage(userMessage, currentStep, collectedData) {
  return fallbackProcess(userMessage, currentStep, collectedData)
}

export { STEPS }
